<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
    <title>CAPSUL &#8212; CAPSUL - Chain algorithm in pipelines and execute in many contexts</title>
  <!-- htmltitle is before nature.css - we use this hack to load bootstrap first -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../../../_static/css/bootstrap.min.css" media="screen" />
  <link rel="stylesheet" href="../../../_static/css/bootstrap-responsive.css"/>
  <link rel="icon" href="../../../_static/capsul_logo.svg"/>

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=f0b81668" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
    
    <script src="../../../_static/documentation_options.js?v=4d935f96"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

  <!-- sidebar -->
  
   
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../../../_static/js/bootstrap.min.js" type="application/javascript"></script>

  <script type="application/javascript">
    $("div.buttonNext, div.buttonPrevious").hover(
       function () {
           $(this).css('background-color', '#FF9C34');
       },
       function () {
           $(this).css('background-color', '#A7D6E2');
       }
    );
    var bodywrapper = $('.bodywrapper');
    var sidebarbutton = $('#sidebarbutton');
    sidebarbutton.css({'height': '900px'});
  </script>

  <div class="header" style="display: inline; width: 80%; margin-left:10%;">
    <a href="../../../index.html">
    <img src="../../../_static/capsul_logo.svg" alt="Capsul logo" style="display: inline; height:4em;"/>
    </a >
    <div class="navbar" style="display: inline;">
      <ul>
        <li><a href="../../../index.html">Home</a></li>
        <li><a href="../../../installation.html">Installation</a></li>
        <li class="btn-li">
          <div class="btn-group">
            <a href="../../../documentation.html">Documentation</a>
            <a class="btn dropdown-toggle" data-toggle="dropdown">
              <span class="caret"></span>
            </a>
            <ul class="dropdown-menu">
              <li class="link-title">CAPSUL</li>
              <li><a href="../../../user_guide_tree/index.html">User guide</a></li>
              <li><a href="../../../api/index.html">API</a></li>
            </ul>
          </div>
        </li>
        <li>
          <!-- form action="search.html" method="get" style="display: inline-block;"></form>
            <input type="text" class="search-header" name="q" placeholder="search documentation..." value=""></input>
            <button type="submit" >search</button>
          </form -->
          <form class="search_box" method="get" action="http://www.google.com/search" style="display: inline-block;">
            <input class="search-header" type="text" name="q" placeholder="search documentation..." />
            <input class="submit" type="image" src="../../../_static/find_read.png" value="Search" />
            <input type="hidden" name="sitesearch" value="brainvisa.info/capsul" />
          </form>
        </li>
      </ul>
    </div> <!-- end navbar -->
  </div>


  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CAPSUL</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CAPSUL</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for capsul.pipeline.pipeline_tools</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Miscellaneous pipeline handling utility functions</span>

<span class="sd">Functions</span>
<span class="sd">=========</span>
<span class="sd">:func:`pipeline_node_colors`</span>
<span class="sd">----------------------------</span>
<span class="sd">:func:`pipeline_link_color`</span>
<span class="sd">---------------------------</span>
<span class="sd">:func:`dot_graph_from_pipeline`</span>
<span class="sd">-------------------------------</span>
<span class="sd">:func:`dot_graph_from_workflow`</span>
<span class="sd">-------------------------------</span>
<span class="sd">:func:`save_dot_graph`</span>
<span class="sd">----------------------</span>
<span class="sd">:func:`save_dot_image`</span>
<span class="sd">----------------------</span>
<span class="sd">:func:`disable_runtime_steps_with_existing_outputs`</span>
<span class="sd">---------------------------------------------------</span>
<span class="sd">:func:`nodes_with_existing_outputs`</span>
<span class="sd">-----------------------------------</span>
<span class="sd">:func:`nodes_with_missing_inputs`</span>
<span class="sd">---------------------------------</span>
<span class="sd">:func:`where_is_plug_value_from`</span>
<span class="sd">--------------------------------</span>
<span class="sd">:func:`dump_pipeline_state_as_dict`</span>
<span class="sd">-----------------------------------</span>
<span class="sd">:func:`set_pipeline_state_from_dict`</span>
<span class="sd">------------------------------------</span>
<span class="sd">:func:`get_output_directories`</span>
<span class="sd">------------------------------</span>
<span class="sd">:func:`create_output_directories`</span>
<span class="sd">---------------------------------</span>
<span class="sd">:func:`save_pipeline`</span>
<span class="sd">---------------------</span>
<span class="sd">:func:`load_pipeline_parameters`</span>
<span class="sd">--------------------------------</span>
<span class="sd">:func:`save_pipeline_parameters`</span>
<span class="sd">--------------------------------</span>
<span class="sd">:func:`is_node_enabled`</span>
<span class="sd">-----------------------</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="c1"># System import</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">soma.subprocess</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="c1"># Define the logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Trait import</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">traits</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">traits</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">enthought.traits</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">traits</span>

<span class="c1"># Capsul import</span>
<span class="kn">from</span> <span class="nn">capsul.pipeline.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">PipelineNode</span><span class="p">,</span> <span class="n">Switch</span><span class="p">,</span> \
    <span class="n">ProcessNode</span><span class="p">,</span> <span class="n">OptionalOutputSwitch</span>
<span class="kn">from</span> <span class="nn">capsul.pipeline.process_iteration</span> <span class="kn">import</span> <span class="n">ProcessIteration</span>
<span class="kn">from</span> <span class="nn">soma.controller</span> <span class="kn">import</span> <span class="n">Controller</span>


<div class="viewcode-block" id="pipeline_node_colors">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.pipeline_node_colors">[docs]</a>
<span class="k">def</span> <span class="nf">pipeline_node_colors</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Node color to display boxes in GUI and graphviz graphs. Depending on the</span>
<span class="sd">    node type (process, pipeline, switch) and its activation, colors will</span>
<span class="sd">    differ.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline: Pipeline</span>
<span class="sd">        the pipeline the node belongs to</span>
<span class="sd">    node: Node</span>
<span class="sd">        the node to be colored</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    colors: tuple</span>
<span class="sd">        (box_color, background_fill_color, dark_color, style). Colors are</span>
<span class="sd">        3-tuples of float values between 0. and 1. style is &quot;default&quot;,</span>
<span class="sd">        &quot;switch&quot; or &quot;pipeline&quot;.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_color_disabled</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.86</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">,</span> <span class="mf">0.86</span><span class="p">]</span>
        <span class="n">new_color</span> <span class="o">=</span> <span class="p">((</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">target</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_color</span>

    <span class="c1">#     BLUE_1 = (0.7, 0.7, 0.9)</span>
    <span class="c1">#     BLUE_2 = (0.5, 0.5, 0.7)</span>
    <span class="c1">#     BLUE_3 = (0.2, 0.2, 0.4)</span>
    <span class="c1">#     LIGHT_BLUE_1 = (0.95, 0.95, 1.0)</span>
    <span class="c1">#     LIGHT_BLUE_2 = (0.85, 0.85, 0.9)</span>
    <span class="c1">#     LIGHT_BLUE_3 = (0.3, 0.3, 0.5)</span>

    <span class="c1"># for process nodes</span>
    <span class="n">GREENDARK_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># active</span>
    <span class="n">GREENDARK_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">GREENDARK_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">LIGHT_GREENDARK_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># not active</span>
    <span class="n">LIGHT_GREENDARK_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">LIGHT_GREENDARK_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># for inputs and outputs nodes</span>
    <span class="n">SEA_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">)</span>  <span class="c1"># active</span>
    <span class="n">SEA_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">)</span>
    <span class="n">SEA_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">)</span>
    <span class="n">LIGHT_SEA_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># not active</span>
    <span class="n">LIGHT_SEA_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">LIGHT_SEA_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># for switch nodes</span>
    <span class="n">SAND_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">SAND_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">SAND_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">LIGHT_SAND_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.48</span><span class="p">)</span>
    <span class="n">LIGHT_SAND_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.73</span><span class="p">)</span>
    <span class="n">LIGHT_SAND_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># for pipeline nodes</span>
    <span class="n">PURPLE_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>  <span class="c1"># not active</span>
    <span class="n">PURPLE_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.49</span><span class="p">,</span> <span class="mf">0.27</span><span class="p">,</span> <span class="mf">0.49</span><span class="p">)</span>
    <span class="n">PURPLE_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.62</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">)</span>
    <span class="n">DEEP_PURPLE_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.72</span><span class="p">,</span> <span class="mf">0.51</span><span class="p">,</span> <span class="mf">0.74</span><span class="p">)</span>  <span class="c1"># active</span>
    <span class="n">DEEP_PURPLE_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.52</span><span class="p">,</span> <span class="mf">0.41</span><span class="p">,</span> <span class="mf">0.54</span><span class="p">)</span>
    <span class="n">DEEP_PURPLE_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.31</span><span class="p">,</span> <span class="mf">0.34</span><span class="p">)</span>

<span class="c1">#     PURPLE_1 = (0.85, 0.8, 0.85)</span>
<span class="c1">#     PURPLE_2 = (0.8, 0.75, 0.8)</span>
<span class="c1">#     PURPLE_3 = (0.5, 0.45, 0.5)</span>
<span class="c1">#     DEEP_PURPLE_1 = (0.8, 0.7, 0.8)</span>
<span class="c1">#     DEEP_PURPLE_2 = (0.6, 0.5, 0.6)</span>
<span class="c1">#     DEEP_PURPLE_3 = (0.4, 0.35, 0.4)</span>

    <span class="c1"># for iteration nodes</span>
    <span class="n">GREEN_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
    <span class="n">GREEN_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">GREEN_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">LIGHT_GREEN_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
    <span class="n">LIGHT_GREEN_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">)</span>
    <span class="n">LIGHT_GREEN_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># for attributed nodes</span>
    <span class="n">SKY_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">SKY_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
    <span class="n">SKY_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">LIGHT_SKY_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">LIGHT_SKY_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
    <span class="n">LIGHT_SKY_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>

    <span class="n">APPLE_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
    <span class="n">APPLE_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">APPLE_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">LIGHT_APPLE_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.48</span><span class="p">)</span>
    <span class="n">LIGHT_APPLE_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.73</span><span class="p">)</span>
    <span class="n">LIGHT_APPLE_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># for custom_nodes</span>
    <span class="n">ORANGE_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.92</span><span class="p">,</span> <span class="mf">0.69</span><span class="p">,</span> <span class="mf">0.53</span><span class="p">)</span>
    <span class="c1">#ORANGE_2 = (0.73, 0.4, 0.26)</span>
    <span class="n">ORANGE_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.86</span><span class="p">,</span> <span class="mf">0.54</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ORANGE_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">LIGHT_ORANGE_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">,</span> <span class="mf">0.88</span><span class="p">)</span>
    <span class="n">LIGHT_ORANGE_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
    <span class="n">LIGHT_ORANGE_3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>

    <span class="n">_colors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">GREENDARK_1</span><span class="p">,</span> <span class="n">GREENDARK_2</span><span class="p">,</span> <span class="n">GREENDARK_3</span><span class="p">,</span> <span class="n">LIGHT_GREENDARK_1</span><span class="p">,</span> <span class="n">LIGHT_GREENDARK_2</span><span class="p">,</span>
                    <span class="n">LIGHT_GREENDARK_3</span><span class="p">),</span>
        <span class="s1">&#39;switch&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">SAND_1</span><span class="p">,</span> <span class="n">SAND_2</span><span class="p">,</span> <span class="n">SAND_3</span><span class="p">,</span> <span class="n">LIGHT_SAND_1</span><span class="p">,</span> <span class="n">LIGHT_SAND_2</span><span class="p">,</span>
                   <span class="n">LIGHT_SAND_3</span><span class="p">),</span>
        <span class="s1">&#39;pipeline&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">DEEP_PURPLE_1</span><span class="p">,</span> <span class="n">DEEP_PURPLE_2</span><span class="p">,</span> <span class="n">DEEP_PURPLE_3</span><span class="p">,</span> <span class="n">PURPLE_1</span><span class="p">,</span>
                     <span class="n">PURPLE_2</span><span class="p">,</span> <span class="n">PURPLE_3</span><span class="p">),</span>
        <span class="s1">&#39;pipeline_io&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">SEA_1</span><span class="p">,</span> <span class="n">SEA_2</span><span class="p">,</span> <span class="n">SEA_3</span><span class="p">,</span> <span class="n">LIGHT_SEA_1</span><span class="p">,</span> <span class="n">LIGHT_SEA_2</span><span class="p">,</span>
                        <span class="n">LIGHT_SEA_3</span><span class="p">),</span>
        <span class="s1">&#39;iteration&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">GREEN_1</span><span class="p">,</span> <span class="n">GREEN_2</span><span class="p">,</span> <span class="n">GREEN_3</span><span class="p">,</span> <span class="n">LIGHT_GREEN_1</span><span class="p">,</span> <span class="n">LIGHT_GREEN_2</span><span class="p">,</span>
                      <span class="n">LIGHT_GREEN_3</span><span class="p">),</span>
        <span class="s1">&#39;attributed&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">SKY_1</span><span class="p">,</span> <span class="n">SKY_2</span><span class="p">,</span> <span class="n">SKY_3</span><span class="p">,</span> <span class="n">LIGHT_SKY_1</span><span class="p">,</span> <span class="n">LIGHT_SKY_2</span><span class="p">,</span>
                       <span class="n">LIGHT_SKY_3</span><span class="p">),</span>
        <span class="s1">&#39;optional_output_switch&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">APPLE_1</span><span class="p">,</span> <span class="n">APPLE_2</span><span class="p">,</span> <span class="n">APPLE_3</span><span class="p">,</span> <span class="n">LIGHT_APPLE_1</span><span class="p">,</span>
                                   <span class="n">LIGHT_APPLE_2</span><span class="p">,</span> <span class="n">LIGHT_APPLE_3</span><span class="p">),</span>
        <span class="s1">&#39;custom_node&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ORANGE_1</span><span class="p">,</span> <span class="n">ORANGE_2</span><span class="p">,</span> <span class="n">ORANGE_3</span><span class="p">,</span> <span class="n">LIGHT_ORANGE_1</span><span class="p">,</span>
                        <span class="n">LIGHT_ORANGE_2</span><span class="p">,</span> <span class="n">LIGHT_ORANGE_3</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="p">:</span>
        <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;pipeline_io&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">OptionalOutputSwitch</span><span class="p">):</span>
        <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;optional_output_switch&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Switch</span><span class="p">):</span>
        <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;switch&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">PipelineNode</span><span class="p">):</span>
        <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;pipeline&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">ProcessIteration</span><span class="p">):</span>
        <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;iteration&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ProcessNode</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="s1">&#39;completion_engine&#39;</span><span class="p">):</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;attributed&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;custom_node&#39;</span>
    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">activated</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
        <span class="n">color_1</span><span class="p">,</span> <span class="n">color_2</span><span class="p">,</span> <span class="n">color_3</span> <span class="o">=</span> <span class="n">_colors</span><span class="p">[</span><span class="n">style</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color_1</span><span class="p">,</span> <span class="n">color_2</span><span class="p">,</span> <span class="n">color_3</span> <span class="o">=</span> <span class="n">_colors</span><span class="p">[</span><span class="n">style</span><span class="p">][</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">disabled_pipeline_steps_nodes</span><span class="p">():</span>
        <span class="n">color_1</span> <span class="o">=</span> <span class="n">_color_disabled</span><span class="p">(</span><span class="n">color_1</span><span class="p">)</span>
        <span class="n">color_2</span> <span class="o">=</span> <span class="n">_color_disabled</span><span class="p">(</span><span class="n">color_2</span><span class="p">)</span>
        <span class="n">color_3</span> <span class="o">=</span> <span class="n">_color_disabled</span><span class="p">(</span><span class="n">color_3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">color_1</span><span class="p">,</span> <span class="n">color_2</span><span class="p">,</span> <span class="n">color_3</span><span class="p">,</span> <span class="n">style</span></div>



<div class="viewcode-block" id="pipeline_link_color">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.pipeline_link_color">[docs]</a>
<span class="k">def</span> <span class="nf">pipeline_link_color</span><span class="p">(</span><span class="n">plug</span><span class="p">,</span> <span class="n">link</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Link color and style for graphical display and graphviz graphs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plug: Plug</span>
<span class="sd">        the plug the link belong to</span>
<span class="sd">    link: link tuple (5 values)</span>
<span class="sd">        link to color</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    link_props: tuple</span>
<span class="sd">        (color, style, active, weak) where color is a RGB tuple of float values</span>
<span class="sd">        (between 0. and 1.), style is a string (&quot;solid&quot;, &quot;dotted&quot;), active and</span>
<span class="sd">        weak are booleans.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">GRAY_1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
    <span class="n">RED_2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.92</span><span class="p">,</span> <span class="mf">0.51</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">)</span>

    <span class="n">active</span> <span class="o">=</span> <span class="n">plug</span><span class="o">.</span><span class="n">activated</span> <span class="ow">and</span> <span class="n">link</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">activated</span>
    <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">RED_2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">GRAY_1</span>
    <span class="n">weak</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">weak</span><span class="p">:</span>  <span class="c1"># weak link</span>
        <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span>
    <span class="k">return</span> <span class="n">color</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">weak</span></div>



<div class="viewcode-block" id="dot_graph_from_pipeline">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.dot_graph_from_pipeline">[docs]</a>
<span class="k">def</span> <span class="nf">dot_graph_from_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">nodes_sizes</span><span class="o">=</span><span class="p">{},</span> <span class="n">use_nodes_pos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">include_io</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enlarge_boxes</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build a graphviz/dot-compatible representation of the pipeline.</span>
<span class="sd">    The pipeline representation uses one link between two given boxes:</span>
<span class="sd">    parameters are not represented.</span>

<span class="sd">    This is different from the workflow graph, as given by</span>
<span class="sd">    :py:meth:`capsul.pipeline.Pipeline.workflow_graph`, in that the full graph</span>
<span class="sd">    is represented here, including disabled nodes.</span>

<span class="sd">    To build a workflow graph, see :py:func:`dot_graph_from_workflow`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline: Pipeline</span>
<span class="sd">        pipeline to convert to a dot graph</span>
<span class="sd">    nodes_sizes: dict (optional)</span>
<span class="sd">        nodes sizes may be specified here, keys are node names, and values are</span>
<span class="sd">        tuples (width, height). Special &quot;inputs&quot; and &quot;outputs&quot; keys represent</span>
<span class="sd">        the global inputs/outputs blocks of the pipeline.</span>
<span class="sd">    use_nodes_pos: bool (optional)</span>
<span class="sd">        if True, nodes positions in the pipeline.node_position variable will</span>
<span class="sd">        be used to force nodes positions in the graph.</span>
<span class="sd">    include_io: bool (optional)</span>
<span class="sd">        If True, build a node for the pipeline inputs and a node for the</span>
<span class="sd">        pipeline outputs. If False, these nodes will not be generated, and</span>
<span class="sd">        their links ignored.</span>
<span class="sd">    enlarge_boxes: float (optional)</span>
<span class="sd">        when nodes sizes are specified, enlarge them by this amount to produce</span>
<span class="sd">        bigger boxes</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dot_graph: tuple</span>
<span class="sd">        a (nodes, edges) tuple, where nodes is a list of node tuples</span>
<span class="sd">        (id, node_name, props) and edges is a dict, where</span>
<span class="sd">        keys are (source_node_id, dest_node_id), and values are tuples</span>
<span class="sd">        (props, active, weak). In both cases props is a dictionary of</span>
<span class="sd">        properties.</span>
<span class="sd">        This representation is simple and is meant to feed</span>
<span class="sd">        :py:func:`save_dot_graph`</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_link_color</span><span class="p">(</span><span class="n">plug</span><span class="p">,</span> <span class="n">link</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>  <span class="c1"># weak link</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;dotted&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span>
        <span class="n">active</span> <span class="o">=</span> <span class="n">plug</span><span class="o">.</span><span class="n">activated</span> <span class="ow">and</span> <span class="n">link</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">activated</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">style</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">link</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">has_outputs</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">nodes_pos</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">node_position</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">67.</span>

    <span class="k">for</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_io</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;inputs&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">node_name</span>
        <span class="n">color</span><span class="p">,</span> <span class="n">bgcolor</span><span class="p">,</span> <span class="n">darkcolor</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="n">pipeline_node_colors</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="n">colorstr</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">%02x%02x%02x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mf">255.9</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">darkcolor</span><span class="p">])</span>
        <span class="n">bgcolorstr</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">%02x%02x%02x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mf">255.9</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bgcolor</span><span class="p">])</span>
        <span class="n">node_props</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">colorstr</span><span class="p">,</span> <span class="s1">&#39;fillcolor&#39;</span><span class="p">:</span> <span class="n">bgcolorstr</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;switch&#39;</span><span class="p">:</span>
            <span class="n">node_props</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="s1">&#39;house&#39;</span><span class="p">,</span> <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="mf">270.</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_props</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="s1">&#39;box&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">use_nodes_pos</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">nodes_pos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">node_props</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">,</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
                                                     <span class="o">-</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)})</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">nodes_sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node_props</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">enlarge_boxes</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
                               <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">enlarge_boxes</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
                               <span class="s1">&#39;fixedsize&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">node_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">id</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">node_props</span><span class="p">))</span>
        <span class="n">has_inputs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">plugs</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">plug</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="n">node_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">plug</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="n">node_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">has_inputs</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">links</span> <span class="o">=</span> <span class="n">plug</span><span class="o">.</span><span class="n">links_to</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                    <span class="n">color</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">weak</span> <span class="o">=</span> <span class="n">pipeline_link_color</span><span class="p">(</span>
                        <span class="n">plug</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
                    <span class="n">dest</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">dest</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_io</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">dest</span> <span class="o">=</span> <span class="s1">&#39;outputs&#39;</span>
                        <span class="n">has_outputs</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                    <span class="n">old_edge</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">old_edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># use stongest color/style</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">old_edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">weak</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">style</span> <span class="o">=</span> <span class="n">old_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;style&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">old_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">active</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="n">old_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">%02x%02x%02x</span><span class="s1">&#39;</span> \
                                <span class="o">%</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mf">255.9</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">color</span><span class="p">])</span>
                    <span class="n">props</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">:</span> <span class="n">style</span><span class="p">}</span>
                    <span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">include_io</span><span class="p">:</span>
            <span class="n">main_node_props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">node_props</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_inputs</span><span class="p">:</span>
                <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="n">node_props</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">has_outputs</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">nodes_sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outputs&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;fixedsize&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">main_node_props</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">main_node_props</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">main_node_props</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">enlarge_boxes</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
                 <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">enlarge_boxes</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
                 <span class="s1">&#39;fixedsize&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">})</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;outputs&#39;</span><span class="p">,</span> <span class="s1">&#39;outputs&#39;</span><span class="p">,</span> <span class="n">main_node_props</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span></div>



<div class="viewcode-block" id="dot_graph_from_workflow">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.dot_graph_from_workflow">[docs]</a>
<span class="k">def</span> <span class="nf">dot_graph_from_workflow</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">nodes_sizes</span><span class="o">=</span><span class="p">{},</span> <span class="n">use_nodes_pos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">enlarge_boxes</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build a graphviz/dot-compatible representation of the pipeline workflow.</span>

<span class="sd">    This is different from the pipeline graph, as obtained</span>
<span class="sd">    by:py:func:`dot_graph_from_pipeline`, since only used parts are visible</span>
<span class="sd">    here: switches and disabled branches are removed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline: Pipeline</span>
<span class="sd">        pipeline to convert to a dot graph</span>
<span class="sd">    nodes_sizes: dict (optional)</span>
<span class="sd">        nodes sizes may be specified here, keys are node names, and values are</span>
<span class="sd">        tuples (width, height). Special &quot;inputs&quot; and &quot;outputs&quot; keys represent</span>
<span class="sd">        the global inputs/outputs blocks of the pipeline.</span>
<span class="sd">    use_nodes_pos: bool (optional)</span>
<span class="sd">        if True, nodes positions in the pipeline.node_position variable will</span>
<span class="sd">        be used to force nodes positions in the graph.</span>
<span class="sd">    enlarge_boxes: float (optional)</span>
<span class="sd">        when nodes sizes are specified, enlarge them by this amount to produce</span>
<span class="sd">        bigger boxes</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dot_graph: tuple</span>
<span class="sd">        a (nodes, edges) tuple, where nodes is a list of node tuples</span>
<span class="sd">        (id, node_name, props) and edges is a dict, where</span>
<span class="sd">        keys are (source_node_id, dest_node_id), and values are tuples</span>
<span class="sd">        (props, active, weak). In both cases props is a dictionary of</span>
<span class="sd">        properties.</span>
<span class="sd">        This representation is simple and is meant to feed</span>
<span class="sd">        :py:func:`save_dot_graph`</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">graph</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">workflow_graph</span><span class="p">()</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">67.</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">_nodes</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">color</span><span class="p">,</span> <span class="n">bgcolor</span><span class="p">,</span> <span class="n">darkcolor</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="n">pipeline_node_colors</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="n">colorstr</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">%02x%02x%02x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mf">255.9</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">darkcolor</span><span class="p">])</span>
        <span class="n">bgcolorstr</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">%02x%02x%02x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mf">255.9</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bgcolor</span><span class="p">])</span>
        <span class="n">node_props</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">colorstr</span><span class="p">,</span> <span class="s1">&#39;fillcolor&#39;</span><span class="p">:</span> <span class="n">bgcolorstr</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;switch&#39;</span><span class="p">:</span>
            <span class="n">node_props</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="s1">&#39;house&#39;</span><span class="p">,</span> <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="mf">270.</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_props</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="s1">&#39;box&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">use_nodes_pos</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">node_position</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">node_props</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">,</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
                                                     <span class="o">-</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)})</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">nodes_sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node_props</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">enlarge_boxes</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
                               <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">enlarge_boxes</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
                               <span class="s1">&#39;fixedsize&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">})</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">node_props</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">_links</span><span class="p">:</span>
        <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">props</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;#eb821e&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">:</span> <span class="s1">&#39;solid&#39;</span><span class="p">}</span>
        <span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span></div>



<div class="viewcode-block" id="save_dot_graph">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.save_dot_graph">[docs]</a>
<span class="k">def</span> <span class="nf">save_dot_graph</span><span class="p">(</span><span class="n">dot_graph</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Write a graphviz/dot input file, which can be used to generate an</span>
<span class="sd">    image representation of the graph, or to make dot automatically</span>
<span class="sd">    position nodes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dot_graph: dot graph</span>
<span class="sd">        representation of the pipeline, obatained using</span>
<span class="sd">        :py:func:`dot_graph_from_pipeline`</span>
<span class="sd">    filename: string</span>
<span class="sd">        file name to save the dot definition in</span>
<span class="sd">    **kwargs: additional attributes for the dot graph</span>
<span class="sd">      like nodesep=0.1 or rankdir=&quot;TB&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_str_repr</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">item</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="n">fileobj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">props</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rankdir&#39;</span><span class="p">:</span> <span class="s1">&#39;LR&#39;</span><span class="p">}</span>
    <span class="n">props</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">propsstr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;=&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">aname</span><span class="p">,</span> <span class="n">_str_repr</span><span class="p">(</span><span class="n">val</span><span class="p">)])</span>
                         <span class="k">for</span> <span class="n">aname</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">props</span><span class="p">)])</span>
    <span class="n">rankdir</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;rankdir&#39;</span><span class="p">]</span>

    <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;digraph {</span><span class="si">%s</span><span class="s1">;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">propsstr</span><span class="p">)</span>
    <span class="n">nodesep</span> <span class="o">=</span> <span class="mf">20.</span>  <span class="c1"># in qt scale space</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">67.</span>
    <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="n">dot_graph</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">rankdir</span> <span class="o">==</span> <span class="s1">&#39;TB&#39;</span> <span class="ow">and</span> <span class="s1">&#39;orientation&#39;</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
            <span class="n">props</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">90</span>
        <span class="n">attstr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;=&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">aname</span><span class="p">,</span> <span class="n">_str_repr</span><span class="p">(</span><span class="n">val</span><span class="p">)])</span>
                           <span class="k">for</span> <span class="n">aname</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">props</span><span class="p">)])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">props</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">attstr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">attstr</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &quot;</span><span class="si">%s</span><span class="s1">&quot; [label=&quot;</span><span class="si">%s</span><span class="s1">&quot; style=&quot;filled&quot;</span><span class="si">%s</span><span class="s1">];</span><span class="se">\n</span><span class="s1">&#39;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">attstr</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">descr</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">dot_graph</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">descr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">attstr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;=&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">aname</span><span class="p">,</span> <span class="n">_str_repr</span><span class="p">(</span><span class="n">val</span><span class="p">)])</span>
                           <span class="k">for</span> <span class="n">aname</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">props</span><span class="p">)])</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &quot;</span><span class="si">%s</span><span class="s1">&quot; -&gt; &quot;</span><span class="si">%s</span><span class="s1">&quot; [</span><span class="si">%s</span><span class="s1">];</span><span class="se">\n</span><span class="s1">&#39;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">attstr</span><span class="p">))</span>
    <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="save_dot_image">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.save_dot_image">[docs]</a>
<span class="k">def</span> <span class="nf">save_dot_image</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">nodes_sizes</span><span class="o">=</span><span class="p">{},</span> <span class="n">use_nodes_pos</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">include_io</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enlarge_boxes</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">workflow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Save a dot/graphviz image of the pipeline in a file.</span>

<span class="sd">    It may use either the complete pipeline graph (with switches and disabled</span>
<span class="sd">    branches), or the workflow, hiding disabled parts (see the workflow</span>
<span class="sd">    parameter).</span>

<span class="sd">    Basically combines :py:func:`dot_graph_from_pipeline` or</span>
<span class="sd">    :py:func:`dot_graph_from_workflow`, and :py:func:`save_dot_graph`, then</span>
<span class="sd">    runs the `dot &lt;http://www.graphviz.org&gt;`_ command, which has to be</span>
<span class="sd">    installed and available on the system.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline: Pipeline</span>
<span class="sd">        pipeline to convert to a dot graph</span>
<span class="sd">    filename: string</span>
<span class="sd">        file name to save the dot definition in.</span>
<span class="sd">    nodes_sizes: dict (optional)</span>
<span class="sd">        nodes sizes may be specified here, keys are node names, and values are</span>
<span class="sd">        tuples (width, height). Special &quot;inputs&quot; and &quot;outputs&quot; keys represent</span>
<span class="sd">        the global inputs/outputs blocks of the pipeline.</span>
<span class="sd">    use_nodes_pos: bool (optional)</span>
<span class="sd">        if True, nodes positions in the pipeline.node_position variable will</span>
<span class="sd">        be used to force nodes positions in the graph.</span>
<span class="sd">    include_io: bool (optional)</span>
<span class="sd">        If True, build a node for the pipeline inputs and a node for the</span>
<span class="sd">        pipeline outputs. If False, these nodes will not be generated, and</span>
<span class="sd">        their links ignored.</span>
<span class="sd">    enlarge_boxes: float (optional)</span>
<span class="sd">        when nodes sizes are specified, enlarge them by this amount to produce</span>
<span class="sd">        bigger boxes</span>
<span class="sd">    workflow: bool (optional)</span>
<span class="sd">        if True, the workflow corresponding to the current pipeline state will</span>
<span class="sd">        be used instead of the complete graph: disabled parts will be hidden.</span>
<span class="sd">    format: string (optional)</span>
<span class="sd">        dot output format (see `dot &lt;http://www.graphviz.org&gt;`_ command doc).</span>
<span class="sd">        If not specified, guessed from the file name extension.</span>
<span class="sd">    **kwargs: additional attributes for the dot graph</span>
<span class="sd">      like nodesep=0.1 or rankdir=&quot;TB&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">workflow</span><span class="p">:</span>
        <span class="n">dgraph</span> <span class="o">=</span> <span class="n">dot_graph_from_workflow</span><span class="p">(</span>
            <span class="n">pipeline</span><span class="p">,</span> <span class="n">nodes_sizes</span><span class="o">=</span><span class="n">nodes_sizes</span><span class="p">,</span> <span class="n">use_nodes_pos</span><span class="o">=</span><span class="n">use_nodes_pos</span><span class="p">,</span>
            <span class="n">enlarge_boxes</span><span class="o">=</span><span class="n">enlarge_boxes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dgraph</span> <span class="o">=</span> <span class="n">dot_graph_from_pipeline</span><span class="p">(</span>
            <span class="n">pipeline</span><span class="p">,</span> <span class="n">nodes_sizes</span><span class="o">=</span><span class="n">nodes_sizes</span><span class="p">,</span> <span class="n">use_nodes_pos</span><span class="o">=</span><span class="n">use_nodes_pos</span><span class="p">,</span>
            <span class="n">include_io</span><span class="o">=</span><span class="n">include_io</span><span class="p">,</span> <span class="n">enlarge_boxes</span><span class="o">=</span><span class="n">enlarge_boxes</span><span class="p">)</span>
    <span class="n">tempf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">tempf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dot_filename</span> <span class="o">=</span> <span class="n">tempf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">save_dot_graph</span><span class="p">(</span><span class="n">dgraph</span><span class="p">,</span> <span class="n">dot_filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">formats</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;txt&#39;</span><span class="p">:</span> <span class="s1">&#39;plain&#39;</span><span class="p">}</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="n">formats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dot&#39;</span><span class="p">,</span> <span class="s1">&#39;-T</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ext</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dot_filename</span><span class="p">]</span>
    <span class="n">soma</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">dot_filename</span><span class="p">)</span></div>



<div class="viewcode-block" id="disable_runtime_steps_with_existing_outputs">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.disable_runtime_steps_with_existing_outputs">[docs]</a>
<span class="k">def</span> <span class="nf">disable_runtime_steps_with_existing_outputs</span><span class="p">(</span><span class="n">pipeline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Disable steps in a pipeline which outputs contain existing files. This</span>
<span class="sd">    disabling is the &quot;runtime steps disabling&quot; one (see</span>
<span class="sd">    :py:class:`capsul.pipeline.Pipeline`), not the node disabling with</span>
<span class="sd">    activation propagation, so it doesn&#39;t affect the actual pipeline state.</span>
<span class="sd">    The aim is to prevent overwriting files which have already been processed,</span>
<span class="sd">    and to allow downstream execution of the remaining steps of the pipeline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline: Pipeline (mandatory)</span>
<span class="sd">        pipeline to disable nodes in.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s1">&#39;pipeline_steps&#39;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
            <span class="k">continue</span>  <span class="c1"># already inactive</span>
        <span class="k">for</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="n">trait</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">activated</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># node not active anyway</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">plugs</span><span class="p">:</span>
                <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">)</span>
                                     <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Directory</span><span class="p">)):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span> \
                            <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                        <span class="c1"># check special case when the output is also an input</span>
                        <span class="c1"># (of the same node)</span>
                        <span class="n">disable</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span>
                                                            <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">)</span>
                                                 <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span>
                                                               <span class="n">traits</span><span class="o">.</span><span class="n">Directory</span><span class="p">)):</span>
                                <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                                    <span class="n">disable</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">break</span>  <span class="c1"># found in inputs</span>
                        <span class="k">if</span> <span class="n">disable</span><span class="p">:</span>
                            <span class="c1"># disable step</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;disable step&#39;</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="s1">&#39;because of:&#39;</span><span class="p">,</span>
                                  <span class="n">node_name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                            <span class="c1"># no need to iterate other nodes in same step</span>
                            <span class="k">break</span></div>



<div class="viewcode-block" id="nodes_with_existing_outputs">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.nodes_with_existing_outputs">[docs]</a>
<span class="k">def</span> <span class="nf">nodes_with_existing_outputs</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">exclude_inactive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks nodes in a pipeline which outputs contain existing files on the</span>
<span class="sd">    filesystem. Such nodes, maybe, should not run again. Only nodes which</span>
<span class="sd">    actually produce outputs are selected this way (switches are skipped).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline: Pipeline (mandatory)</span>
<span class="sd">        pipeline to disable nodes in.</span>
<span class="sd">    exclude_inactive: bool (optional)</span>
<span class="sd">        if this option is set, inactive nodes will not be checked</span>
<span class="sd">        nor returned in the list. Inactive means disabled, not active, or in a</span>
<span class="sd">        disabled runtime step.</span>
<span class="sd">        Default: True</span>
<span class="sd">    recursive: bool (optional)</span>
<span class="sd">        if this option is set, sub-pipelines will not be returned as a whole</span>
<span class="sd">        but will be parsed recursively to select individual leaf nodes.</span>
<span class="sd">        Default: False</span>
<span class="sd">    exclude_inputs: bool (optional, default: True)</span>
<span class="sd">        Some processes or pipelines have input/output files: files taken as</span>
<span class="sd">        inputs which are re-written as outputs, or may carry an input file to</span>
<span class="sd">        the outputs through a switch selection (in the case of preprocessing</span>
<span class="sd">        steps, for instance).</span>
<span class="sd">        If this option is set, such outputs which also appear in the same node</span>
<span class="sd">        inputs will not be listed in the existing outputs, so that they will</span>
<span class="sd">        not be erased by a cleaning operation, and will not prevent execution</span>
<span class="sd">        of these nodes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    selected_nodes: dict</span>
<span class="sd">        keys: node names</span>
<span class="sd">        values: list of pairs (param_name, file_name)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">selected_nodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">exclude_inactive</span><span class="p">:</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s1">&#39;pipeline_steps&#39;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">())</span>
        <span class="n">disabled_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
                <span class="n">disabled_nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>

    <span class="c1"># nodes = pipeline.nodes.items()</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">while</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">node_name</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">):</span>
            <span class="c1"># main pipeline node, switch...</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">activated</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="n">exclude_inactive</span> <span class="ow">and</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="n">disabled_nodes</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>
        <span class="k">if</span> <span class="n">recursive</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
            <span class="n">nodes</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">),</span> <span class="n">new_node</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">new_node</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">new_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="n">plug_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">input_files_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">plugs</span><span class="p">):</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Directory</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Any</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> \
                        <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> \
                        <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_files_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">plug</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                        <span class="n">plug_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">plug_name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">exclude_inputs</span><span class="p">:</span>
                        <span class="n">input_files_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exclude_inputs</span><span class="p">:</span>
            <span class="n">new_plug_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">plug_list</span>
                             <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_files_list</span><span class="p">]</span>
            <span class="n">plug_list</span> <span class="o">=</span> <span class="n">new_plug_list</span>
        <span class="k">if</span> <span class="n">plug_list</span><span class="p">:</span>
            <span class="n">selected_nodes</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">plug_list</span>
    <span class="k">return</span> <span class="n">selected_nodes</span></div>



<div class="viewcode-block" id="nodes_with_missing_inputs">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.nodes_with_missing_inputs">[docs]</a>
<span class="k">def</span> <span class="nf">nodes_with_missing_inputs</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks nodes in a pipeline which inputs contain invalid inputs.</span>
<span class="sd">    Inputs which are files non-existing on the filesystem (so, which cannot</span>
<span class="sd">    run), or have missing mandatory inputs, or take as input a temporary file</span>
<span class="sd">    which should be the output from another disabled node, are recorded.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline: Pipeline (mandatory)</span>
<span class="sd">        pipeline to disable nodes in.</span>
<span class="sd">    recursive: bool (optional)</span>
<span class="sd">        if this option is set, sub-pipelines will not be returned as a whole</span>
<span class="sd">        but will be parsed recursively to select individual leaf nodes. Note</span>
<span class="sd">        that if not set, a pipeline is regarded as a process, but pipelines may</span>
<span class="sd">        not use all their inputs/outputs so the result might be inaccurate.</span>
<span class="sd">        Default: True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    selected_nodes: dict</span>
<span class="sd">        keys: node names</span>
<span class="sd">        values: list of pairs (param_name, file_name)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">selected_nodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s1">&#39;pipeline_steps&#39;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">())</span>
    <span class="n">disabled_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
            <span class="n">disabled_nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">[</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="n">trait</span><span class="o">.</span><span class="n">nodes</span><span class="p">])</span>

    <span class="c1"># nodes = pipeline.nodes.items()</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">while</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">node_name</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">):</span>
            <span class="c1"># main pipeline node, switch...</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">activated</span> <span class="ow">or</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">disabled_nodes</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>
        <span class="k">if</span> <span class="n">recursive</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
            <span class="n">nodes</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">),</span> <span class="n">new_node</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">new_node</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">new_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">plugs</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">plug</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">plug_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">)</span> \
                        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Directory</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">plug_name</span><span class="p">)</span>
                    <span class="n">keep_me</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span> \
                            <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                        <span class="c1"># check where this file comes from</span>
                        <span class="n">origin_node</span><span class="p">,</span> <span class="n">origin_param</span><span class="p">,</span> <span class="n">origin_parent</span> \
                            <span class="o">=</span> <span class="n">where_is_plug_value_from</span><span class="p">(</span><span class="n">plug</span><span class="p">,</span> <span class="n">recursive</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">origin_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                                <span class="ow">and</span> <span class="p">(</span><span class="n">origin_node</span> <span class="ow">in</span> <span class="n">disabled_nodes</span>
                                     <span class="ow">or</span> <span class="n">origin_parent</span> <span class="ow">in</span> <span class="n">disabled_nodes</span><span class="p">):</span>
                            <span class="c1"># file coming from another disabled node</span>
                            <span class="c1"># if not value or value is traits.Undefined:</span>
                            <span class="c1">## temporary one</span>
                            <span class="c1"># print(&#39;TEMP: %s.%s&#39; % (node_name, plug_name))</span>
                            <span class="c1"># value = None</span>
                            <span class="n">keep_me</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">origin_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># unplugged: does not come from anywhere else</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span> <span class="ow">and</span> <span class="n">value</span><span class="p">)</span> \
                                    <span class="ow">or</span> <span class="ow">not</span> <span class="n">plug</span><span class="o">.</span><span class="n">optional</span><span class="p">:</span>
                                <span class="c1"># non-empty value, non-existing file</span>
                                <span class="c1"># or mandatory, empty value</span>
                                <span class="n">keep_me</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># the rest is a plugged input from another process,</span>
                        <span class="c1"># or an optional empty value</span>
                    <span class="k">if</span> <span class="n">keep_me</span><span class="p">:</span>
                        <span class="n">plug_list</span> <span class="o">=</span> <span class="n">selected_nodes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="p">[])</span>
                        <span class="n">plug_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">plug_name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">selected_nodes</span></div>



<div class="viewcode-block" id="where_is_plug_value_from">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.where_is_plug_value_from">[docs]</a>
<span class="k">def</span> <span class="nf">where_is_plug_value_from</span><span class="p">(</span><span class="n">plug</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find where the given (input) plug takes its value from.</span>
<span class="sd">    It has to be the output of an uphill process, or be unconnected.</span>
<span class="sd">    Looking for it may involve ascending through switches or pipeline walls.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plug: Plug instance (mandatory)</span>
<span class="sd">        the plug to find source connection with</span>
<span class="sd">    recursive: bool (optional)</span>
<span class="sd">        if this option is set, sub-pipelines will not be returned as a whole</span>
<span class="sd">        but will be parsed recursively to select individual leaf nodes. Note</span>
<span class="sd">        that if not set, a pipeline is regarded as a process, but pipelines may</span>
<span class="sd">        not use all their inputs/outputs so the result might be inaccurate.</span>
<span class="sd">        Default: True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    node: Node</span>
<span class="sd">        origin pipeline node. May be None if the plug was not connected to an</span>
<span class="sd">        active source.</span>
<span class="sd">    param_name: string</span>
<span class="sd">        origin plug name in the origin node. May be None if node is None</span>
<span class="sd">    parent: Node</span>
<span class="sd">        Top-level parent node of the origin node. Useful to determine if the</span>
<span class="sd">        origin node is in a runtime pipeline step, which only records top-level</span>
<span class="sd">        nodes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="o">+</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">plug</span><span class="o">.</span><span class="n">links_from</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">links</span><span class="p">:</span>
        <span class="n">node_name</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">in_plug</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">activated</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="c1"># disabled nodes are not influencing</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">PipelineNode</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">recursive</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">node</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">parent</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># recursive</span>
                <span class="c1"># either output from a sibling sub_pipeline</span>
                <span class="c1"># or input from parent pipeline</span>
                <span class="c1"># but it is handled the same way.</span>
                <span class="c1"># check their inputs</span>
                <span class="c1"># just if sibling, keep them as parent</span>
                <span class="k">if</span> <span class="n">in_plug</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_parent</span> <span class="o">=</span> <span class="n">node</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_parent</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="n">links</span> <span class="o">+=</span> <span class="p">[</span><span class="n">link</span> <span class="o">+</span> <span class="p">(</span><span class="n">new_parent</span><span class="p">,)</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">in_plug</span><span class="o">.</span><span class="n">links_from</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_end</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_connections_through</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">other_end</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">other_end</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">other_end</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">parent</span>
    <span class="c1"># not found</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="find_plug_connection_sources">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.find_plug_connection_sources">[docs]</a>
<span class="k">def</span> <span class="nf">find_plug_connection_sources</span><span class="p">(</span><span class="n">plug</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A bit like :func:`where_is_plug_value_from` but looks for all incoming</span>
<span class="sd">    connection sources</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sources:  list</span>
<span class="sd">        [(node, param_name, parent_node), ...]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span>
    <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="o">+</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,)</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">plug</span><span class="o">.</span><span class="n">links_from</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">links</span><span class="p">:</span>
        <span class="n">node_name</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">in_plug</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">activated</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="c1"># disabled nodes are not influencing</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">PipelineNode</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_plug</span><span class="o">.</span><span class="n">links_from</span><span class="p">:</span>
                <span class="c1"># get out of the pipeline: keep it</span>
                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">parent</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="c1"># either output from a sibling sub_pipeline</span>
            <span class="c1"># or input from parent pipeline</span>
            <span class="c1"># but it is handled the same way.</span>
            <span class="c1"># check their inputs</span>
            <span class="c1"># just if sibling, keep them as parent</span>
            <span class="k">if</span> <span class="n">in_plug</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="n">parent</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
                <span class="n">new_parent</span> <span class="o">=</span> <span class="n">node</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_parent</span> <span class="o">=</span> <span class="n">parent</span>
            <span class="n">links</span> <span class="o">+=</span> <span class="p">[</span><span class="n">link</span> <span class="o">+</span> <span class="p">(</span><span class="n">new_parent</span><span class="p">,)</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">in_plug</span><span class="o">.</span><span class="n">links_from</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_end</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_connections_through</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">other_end</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">is</span> <span class="n">pipeline</span> \
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">links_from</span><span class="p">:</span>
                    <span class="c1"># main pipeline input, keep it</span>
                    <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="n">in_plug</span><span class="p">:</span>
                    <span class="c1"># don&#39;t get through its node: keep the node as source</span>
                    <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PipelineNode</span><span class="p">):</span>
                    <span class="c1"># sub-pipeline output: inspect it</span>
                    <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kc">False</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">output</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PipelineNode</span><span class="p">):</span>
                    <span class="c1"># input side of a non-opaque node: inspect its links</span>
                    <span class="n">links</span> <span class="o">+=</span> <span class="p">[</span><span class="n">link</span> <span class="o">+</span> <span class="p">(</span><span class="n">node</span><span class="p">,)</span>
                              <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">links_from</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unhandle case in find_plug_connection_sources&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;node:&#39;</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;, param:&#39;</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">sources</span></div>


<div class="viewcode-block" id="find_plug_connection_destinations">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.find_plug_connection_destinations">[docs]</a>
<span class="k">def</span> <span class="nf">find_plug_connection_destinations</span><span class="p">(</span><span class="n">plug</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A bit like :func:`find_plug_connection_sources` but the other way</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dest:  list</span>
<span class="sd">        [(node, param_name, parent_node), ...]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span>
    <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="o">+</span> <span class="p">(</span><span class="n">pipeline</span><span class="p">,)</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">plug</span><span class="o">.</span><span class="n">links_to</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">links</span><span class="p">:</span>
        <span class="n">node_name</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">in_plug</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">activated</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="c1"># disabled nodes are not influencing</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">PipelineNode</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_plug</span><span class="o">.</span><span class="n">links_to</span><span class="p">:</span>
                <span class="c1"># get out of the pipeline: keep it</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">parent</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="c1"># either input from a sibling sub_pipeline</span>
            <span class="c1"># or output from parent pipeline</span>
            <span class="c1"># but it is handled the same way.</span>
            <span class="c1"># check their inputs</span>
            <span class="c1"># just if sibling, keep them as parent</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_plug</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="n">parent</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
                <span class="n">new_parent</span> <span class="o">=</span> <span class="n">node</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_parent</span> <span class="o">=</span> <span class="n">parent</span>
            <span class="n">links</span> <span class="o">+=</span> <span class="p">[</span><span class="n">link</span> <span class="o">+</span> <span class="p">(</span><span class="n">new_parent</span><span class="p">,)</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">in_plug</span><span class="o">.</span><span class="n">links_to</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_end</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_connections_through</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">other_end</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">is</span> <span class="n">pipeline</span> \
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">links_to</span><span class="p">:</span>
                    <span class="c1"># main pipeline output, keep it</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="n">in_plug</span><span class="p">:</span>
                    <span class="c1"># don&#39;t get through its node: keep the node as dest</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="p">))</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">output</span> \
                        <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PipelineNode</span><span class="p">):</span>
                    <span class="c1"># sub-pipeline input: inspect it</span>
                    <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kc">False</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">output</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PipelineNode</span><span class="p">):</span>
                    <span class="c1"># output side of a non-opaque node: inspect its links</span>
                    <span class="n">links</span> <span class="o">+=</span> <span class="p">[</span><span class="n">link</span> <span class="o">+</span> <span class="p">(</span><span class="n">node</span><span class="p">,)</span>
                              <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">links_to</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unhandle case in find_plug_connection_sources&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;node:&#39;</span><span class="p">,</span> <span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;, param:&#39;</span><span class="p">,</span> <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">dest</span></div>


<div class="viewcode-block" id="dump_pipeline_state_as_dict">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.dump_pipeline_state_as_dict">[docs]</a>
<span class="k">def</span> <span class="nf">dump_pipeline_state_as_dict</span><span class="p">(</span><span class="n">pipeline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get a pipeline state (parameters values, nodes activation, selected</span>
<span class="sd">    steps... in a dictionary.</span>

<span class="sd">    The returned dict may contain sub-pipelines state also.</span>

<span class="sd">    The dict may be saved, and used to restore a pipeline state, using</span>
<span class="sd">    :py:func:`set_pipeline_state_from_dict`.</span>

<span class="sd">    Note that :py:meth:`pipeline.export_to_dict &lt;soma.controller.controller.export_to_dict&gt;`</span>
<span class="sd">    would almost do the job, but does not include the recursive aspect.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline: Pipeline (or Process) instance</span>
<span class="sd">        pipeline (or process) to get state from</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    state_dict: dict</span>
<span class="sd">        pipeline state</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">should_keep_value</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">plug</span><span class="p">,</span> <span class="n">components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Tells if a plug has already been taken into account in the plugs graph.</span>

<span class="sd">        Also filters out switches outputs, which should rather be set via their</span>
<span class="sd">        inputs.</span>

<span class="sd">        To do so, a connected components map has to be built for the plugs</span>
<span class="sd">        graph, which is done is a semi-lazy way in components.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        node: Node</span>
<span class="sd">            pipeline node the pluge belongs to</span>
<span class="sd">        plug: Plug</span>
<span class="sd">            the plug to test</span>
<span class="sd">        components: list of sets of plugs</span>
<span class="sd">            connected components will be added to this components list.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        True if the plug value is a &quot;new&quot; one and should be recorded in the</span>
<span class="sd">        pipeline state. Otherwise it should be discarded (set from another</span>
<span class="sd">        connected plug).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">_component</span><span class="p">(</span><span class="n">plug</span><span class="p">,</span> <span class="n">components</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">comp</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">comp</span> <span class="o">=</span> <span class="n">_component</span><span class="p">(</span><span class="n">plug</span><span class="p">,</span> <span class="n">components</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">:</span>
            <span class="c1"># already done</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># propagate</span>
        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
            <span class="n">plug</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">plug</span><span class="p">)</span>
            <span class="c1"># switches outputs should not be set (they will be through their</span>
            <span class="c1"># inputs)</span>
            <span class="k">if</span> <span class="n">plug</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Switch</span><span class="p">):</span>
                <span class="n">allowed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">todo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">plug</span><span class="o">.</span><span class="n">links_from</span>
                     <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">]</span>
            <span class="n">todo</span> <span class="o">+=</span> <span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">plug</span><span class="o">.</span><span class="n">links_to</span>
                     <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">]</span>
        <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">allowed</span>

    <span class="k">def</span> <span class="nf">prune_empty_dicts</span><span class="p">(</span><span class="n">state_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Remove empty dictionaries, and nodes containing empty dicts in pipeline</span>
<span class="sd">        state dictionary</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        state_dict: dict</span>
<span class="sd">            the state_dict is parsed, and modified.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">state_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nodes&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="p">[(</span><span class="n">state_dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>
        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
            <span class="n">current_dict</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">parent_key</span><span class="p">,</span> <span class="n">recursive</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">current_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nodes&#39;</span><span class="p">)</span>
            <span class="n">modified</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">current_dict</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span>
                    <span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="n">todo</span> <span class="o">=</span> <span class="p">[(</span><span class="n">value</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">nodes</span><span class="p">)]</span> <span class="o">+</span> <span class="n">todo</span>
                    <span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">parent</span><span class="p">[</span><span class="n">parent_key</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">modified</span><span class="p">:</span>
                <span class="n">todo</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_dict</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">parent_key</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

    <span class="n">state_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">)]</span>
    <span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">node_name</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">current_dict</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">):</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>
        <span class="n">node_dict</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">export_to_dict</span><span class="p">()</span>
        <span class="c1"># filter out forbidden and already used plugs</span>
        <span class="k">for</span> <span class="n">plug_name</span><span class="p">,</span> <span class="n">plug</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">plugs</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">should_keep_value</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">plug</span><span class="p">,</span> <span class="n">components</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">node_dict</span><span class="p">[</span><span class="n">plug_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">node_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node_dict</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">current_dict</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_dict</span>
            <span class="n">child_dict</span> <span class="o">=</span> <span class="n">current_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">child_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">current_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="p">{})[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_dict</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node_dict</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">child_dict</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_dict</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">):</span>
            <span class="n">nodes</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">child_node_name</span><span class="p">,</span> <span class="n">child_node</span><span class="p">,</span> <span class="n">child_dict</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">child_node_name</span><span class="p">,</span> <span class="n">child_node</span>
                      <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">child_node_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

    <span class="n">prune_empty_dicts</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">state_dict</span></div>



<div class="viewcode-block" id="set_pipeline_state_from_dict">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.set_pipeline_state_from_dict">[docs]</a>
<span class="k">def</span> <span class="nf">set_pipeline_state_from_dict</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Set a pipeline (or process) state from a dict description.</span>

<span class="sd">    State includes parameters values, nodes activation, steps selection etc.</span>
<span class="sd">    The state is generally taken using :py:func:`dump_pipeline_state_as_dict`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline: Pipeline or Process instance</span>
<span class="sd">        process to set state in</span>
<span class="sd">    state_dict: dict (mapping object)</span>
<span class="sd">        state dictionary</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">)]</span>
    <span class="k">while</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">current_dict</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">):</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">node</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">import_from_dict</span><span class="p">(</span><span class="n">current_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">sub_nodes</span> <span class="o">=</span> <span class="n">current_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nodes&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sub_nodes</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">proc</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_name</span><span class="p">],</span> <span class="n">sub_dict</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">sub_dict</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">sub_nodes</span><span class="p">)]</span></div>



<div class="viewcode-block" id="get_output_directories">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.get_output_directories">[docs]</a>
<span class="k">def</span> <span class="nf">get_output_directories</span><span class="p">(</span><span class="n">process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get output directories for a process, pipeline, or node</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dirs: dict</span>
<span class="sd">        organized directories list: a dict with recursive nodes mapping.</span>
<span class="sd">        In each element, the &quot;directories&quot; key holds a directories names set,</span>
<span class="sd">        and &quot;nodes&quot; is a dict with sub-nodes (node_name, dict mapping,</span>
<span class="sd">        organized the same way)</span>
<span class="sd">    flat_dirs: set</span>
<span class="sd">        set of all directories in the pipeline, as a flat set.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">all_dirs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">root_dirs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">process</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">root_dirs</span><span class="p">)]</span>
    <span class="n">disabled_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
        <span class="n">disabled_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">disabled_pipeline_steps_nodes</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">PipelineNode</span><span class="p">):</span>
        <span class="n">disabled_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">disabled_pipeline_steps_nodes</span><span class="p">())</span>

    <span class="k">while</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">dirs</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plugs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;plugs&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plugs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plugs</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">):</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">node</span>
        <span class="n">dirs_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">dirs</span><span class="p">[</span><span class="s1">&#39;directories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dirs_set</span>
        <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">plugs</span><span class="p">:</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">)</span> \
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Directory</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">param_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">:</span>
                    <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">directory</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
                        <span class="n">all_dirs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                        <span class="n">dirs_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">sub_nodes</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sub_nodes</span><span class="p">:</span>
            <span class="c1"># TODO: handle disabled steps</span>
            <span class="n">sub_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dirs</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_dict</span>
            <span class="k">for</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">sub_nodes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">activated</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">enabled</span> \
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">disabled_nodes</span><span class="p">:</span>
                    <span class="n">sub_node_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">sub_dict</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_node_dict</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">sub_node_dict</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">root_dirs</span><span class="p">,</span> <span class="n">all_dirs</span></div>



<div class="viewcode-block" id="create_output_directories">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.create_output_directories">[docs]</a>
<span class="k">def</span> <span class="nf">create_output_directories</span><span class="p">(</span><span class="n">process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create output directories for a process, pipeline or node.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">get_output_directories</span><span class="p">(</span><span class="n">process</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>



<div class="viewcode-block" id="save_pipeline">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.save_pipeline">[docs]</a>
<span class="k">def</span> <span class="nf">save_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Save the pipeline either in XML, JSON, or .py source file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeline: Pipeline instance</span>
<span class="sd">    file: file object or str</span>
<span class="sd">        either a filename, or a file-like stream</span>
<span class="sd">    format: str</span>
<span class="sd">        &#39;py&#39;, &#39;xml&#39;... If not specified and file is a file name, it will be</span>
<span class="sd">        guessed from its extension. If file is not a string, then format will</span>
<span class="sd">        default to xml.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">capsul.pipeline.xml</span> <span class="kn">import</span> <span class="n">save_xml_pipeline</span>
    <span class="kn">from</span> <span class="nn">capsul.pipeline.python_export</span> <span class="kn">import</span> <span class="n">save_py_pipeline</span>
    <span class="kn">from</span> <span class="nn">capsul.pipeline.json_io</span> <span class="kn">import</span> <span class="n">save_json_pipeline</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
        <span class="c1"># &quot;pipeline&quot; is actually a single process (or should, if it is not a</span>
        <span class="c1"># pipeline). Get it into a pipeline (with a single node) to make the</span>
        <span class="c1"># workflow.</span>
        <span class="n">new_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">()</span>
        <span class="n">new_pipeline</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span>
        <span class="n">new_pipeline</span><span class="o">.</span><span class="n">set_study_config</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">())</span>
        <span class="n">new_pipeline</span><span class="o">.</span><span class="n">add_process</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">)</span>
        <span class="n">new_pipeline</span><span class="o">.</span><span class="n">autoexport_nodes_parameters</span><span class="p">(</span><span class="n">include_optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">new_pipeline</span>

    <span class="n">formats</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;.py&#39;</span><span class="p">:</span> <span class="n">save_py_pipeline</span><span class="p">,</span>
              <span class="s1">&#39;.xml&#39;</span><span class="p">:</span> <span class="n">save_xml_pipeline</span><span class="p">,</span>
              <span class="s1">&#39;.json&#39;</span><span class="p">:</span> <span class="n">save_json_pipeline</span><span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">format</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>

        <span class="n">saved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">writer</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">formats</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">):</span>
                <span class="nb">format</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">format</span><span class="p">:</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;xml&#39;</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">format</span><span class="p">]</span>
    <span class="n">writer</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_pipeline_parameters">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.load_pipeline_parameters">[docs]</a>
<span class="k">def</span> <span class="nf">load_pipeline_parameters</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loading and setting pipeline parameters (inputs and outputs) from a Json file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">dic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;pipeline_parameters&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No &quot;pipeline_parameters&quot; key found in </span><span class="si">{0}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait_value</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">[</span><span class="s2">&quot;pipeline_parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">trait_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
                <span class="c1"># Should we raise an error or just &quot;continue&quot;?</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No &quot;</span><span class="si">{0}</span><span class="s1">&quot; parameter in pipeline.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trait_name</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait_value</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">traits</span><span class="o">.</span><span class="n">TraitError</span><span class="p">:</span>
                <span class="c1"># This case happen when the trait type is date, time or datetime</span>
                <span class="c1"># Couldn&#39;t find an other solution for now</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">pipeline</span><span class="o">.</span><span class="n">update_nodes_and_plugs_activation</span><span class="p">()</span></div>



<div class="viewcode-block" id="save_pipeline_parameters">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.save_pipeline_parameters">[docs]</a>
<span class="k">def</span> <span class="nf">save_pipeline_parameters</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saving pipeline parameters (inputs and outputs) to a Json file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">check_value</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checking if the value is a list, Undefined, a date or a time</span>
<span class="sd">        :param val: value</span>
<span class="sd">        :return: the serializable value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">TraitListObject</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                <span class="n">new_list_value</span> <span class="o">=</span> <span class="n">check_value</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="n">val</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_list_value</span>

        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">val</span>

    <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
        <span class="c1"># Generating the dictionary</span>
        <span class="n">param_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">trait_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nodes_activation&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">check_value</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">))</span>
            <span class="n">param_dic</span><span class="p">[</span><span class="n">trait_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># In the future, more information may be added to this dictionary</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dic</span><span class="p">[</span><span class="s2">&quot;pipeline_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_dic</span>

        <span class="c1"># Saving the dictionary in the Json file</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span></div>



<div class="viewcode-block" id="find_node">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.find_node">[docs]</a>
<span class="k">def</span> <span class="nf">find_node</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Find the given node in the pipeline or a sub-pipeline</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    node_chain: list</span>
<span class="sd">        list of node names in the pipeline going through sub-pipelines to the</span>
<span class="sd">        given node</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pipelines</span> <span class="o">=</span> <span class="p">[(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">pipeline_node</span><span class="p">,</span> <span class="p">[])]</span>
    <span class="k">while</span> <span class="n">pipelines</span><span class="p">:</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">pipelines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sk</span><span class="p">,</span> <span class="n">sn</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">nodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="n">sn</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">names</span> <span class="o">+</span> <span class="p">[</span><span class="n">sk</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">n</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="n">PipelineNode</span><span class="p">):</span>
                <span class="n">pipelines</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sn</span><span class="p">,</span> <span class="n">names</span> <span class="o">+</span> <span class="p">[</span><span class="n">sk</span><span class="p">]))</span>

    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Node </span><span class="si">%s</span><span class="s1"> not found in the pipeline </span><span class="si">%s</span><span class="s1">&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>


<div class="viewcode-block" id="is_node_enabled">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.is_node_enabled">[docs]</a>
<span class="k">def</span> <span class="nf">is_node_enabled</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Checks if the given node is enabled in the pipeline.</span>
<span class="sd">    It may be disabled if it has its ``enabled`` or ``activated`` properties set to False, or if it is part of a disabled step.</span>
<span class="sd">    The node may be given as a Node instance, or its name in the pipeline.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">node_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">activated</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">elif</span> <span class="n">node_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">activated</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># probably a node of a sub-pipeline</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">find_node</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">pipeline</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;pipeline_steps&#39;</span><span class="p">,</span> <span class="n">Controller</span><span class="p">())</span>
        <span class="n">disabled_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">trait</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

    <span class="c1"># not disabled ? OK then it&#39;s enabled</span>
    <span class="k">return</span> <span class="kc">True</span></div>



<span class="k">def</span> <span class="nf">trait_str</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">with_att</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">str_from_trait_id</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">with_att</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">tid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Enum&#39;</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">trait</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
        <span class="n">tname</span> <span class="o">=</span> <span class="n">tid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;List_&#39;</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">tname</span>
            <span class="n">tname</span> <span class="o">=</span> <span class="s1">&#39;List&#39;</span>
            <span class="k">while</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;List_&#39;</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">str_from_trait_id</span><span class="p">([</span><span class="n">t</span><span class="p">],</span> <span class="kc">False</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">with_att</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;output=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">output</span><span class="p">)),</span>
                     <span class="c1">#&#39;default_value=%s&#39; % repr(trait.default),</span>
                     <span class="s1">&#39;optional=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">optional</span><span class="p">))]</span>
            <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">input_filename</span><span class="p">:</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;input_filename=True&#39;</span><span class="p">)</span>
        <span class="n">t_str</span> <span class="o">=</span> <span class="s1">&#39;traits.</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">t_str</span>

    <span class="kn">from</span> <span class="nn">soma.controller.trait_utils</span> <span class="kn">import</span> <span class="n">trait_ids</span>

    <span class="n">tid</span> <span class="o">=</span> <span class="n">trait_ids</span><span class="p">(</span><span class="n">trait</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">str_from_trait_id</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">with_att</span><span class="p">)</span>


<div class="viewcode-block" id="write_fake_process">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.write_fake_process">[docs]</a>
<span class="k">def</span> <span class="nf">write_fake_process</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Write a &quot;fake process&quot; with same class name and parameters as the input</span>
<span class="sd">    process, but with a fake execution function meant for tests.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;# -*- coding: utf-8 -*-</span>

<span class="s1">from capsul.api import Process</span>
<span class="s1">import os</span>
<span class="s1">import traits.api as traits</span>


<span class="s1">class </span><span class="si">%s</span><span class="s1">(Process):</span>
<span class="s1">    def __init__(self):</span>
<span class="s1">        super(</span><span class="si">%s</span><span class="s1">, self).__init__()</span>
<span class="s1">        self.name = &#39;</span><span class="si">%s</span><span class="s1">&#39;</span>

<span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">process</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">t_str</span> <span class="o">=</span> <span class="n">trait_str</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="kc">False</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">trait</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;trait&#39;</span><span class="p">}}</span>
            <span class="n">meta_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
                <span class="n">meta_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                                     <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">t_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">):</span>
                    <span class="n">meta_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">meta_str</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        self.add_trait(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s%s</span><span class="s1">))</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">t_str</span><span class="p">,</span> <span class="n">meta_str</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        self.</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    def _run_process(self):</span>
<span class="s1">        outputs = []</span>
<span class="s1">        for name, trait in self.user_traits().items():</span>
<span class="s1">            if isinstance(trait.trait_type, traits.File):</span>
<span class="s1">                if trait.output:</span>
<span class="s1">                    outputs.append(name)</span>
<span class="s1">                    continue</span>
<span class="s1">                filename = getattr(self, name)</span>
<span class="s1">                if filename not in (None, traits.Undefined, &#39;&#39;):</span>
<span class="s1">                    if not os.path.exists(filename):</span>
<span class="s1">                        raise ValueError(</span>
<span class="s1">                          &#39;Input parameter: </span><span class="si">%s</span><span class="s1">, file </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span>
<span class="s1">                          % (name, repr(filename)))</span>

<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sleep_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        import time</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;        time.sleep(</span><span class="si">%f</span><span class="s1">)</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sleep_time</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;        for name in outputs:</span>
<span class="s1">            trait = self.trait(name)</span>
<span class="s1">            filename = getattr(self, name)</span>
<span class="s1">            if filename not in (None, traits.Undefined, &#39;&#39;):</span>
<span class="s1">                with open(filename, &#39;w&#39;) as f:</span>
<span class="s1">                    f.write(&#39;class: </span><span class="si">%s</span><span class="se">\\</span><span class="s1">n&#39; </span><span class="si">% s</span><span class="s1">elf.__class__.__name__)</span>
<span class="s1">                    f.write(&#39;name: </span><span class="si">%s</span><span class="se">\\</span><span class="s1">n&#39; </span><span class="si">% s</span><span class="s1">elf.name)</span>
<span class="s1">                    f.write(&#39;parameter: </span><span class="si">%s</span><span class="se">\\</span><span class="s1">n&#39; % name)</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_fake_pipeline">
<a class="viewcode-back" href="../../../api/pipeline.html#capsul.pipeline.pipeline_tools.write_fake_pipeline">[docs]</a>
<span class="k">def</span> <span class="nf">write_fake_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Write a &quot;fake pipeline&quot; with same class name, structure, and parameters</span>
<span class="sd">    as the input pipeline, but replacing its processes with &quot;fake&quot; processes</span>
<span class="sd">    which do not actually do a real job while executing.</span>

<span class="sd">    This is meant for tests, to mimic a &quot;real&quot; pipeline structure without its</span>
<span class="sd">    dependencies.</span>

<span class="sd">    :warning:`This function actually modifies the input pipeline, which is</span>
<span class="sd">    transformed into a fake one.`</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">meta_forbidden</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">replace_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">module_name</span><span class="p">,</span> <span class="n">basename</span><span class="p">])</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.py&#39;</span> <span class="o">%</span> <span class="n">basename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
            <span class="n">write_fake_process</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_proc</span> \
                <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">get_process_instance</span><span class="p">(</span>
                    <span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to reload node:&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="n">new_proc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="n">modname</span>

        <span class="c1"># fix fields state (if modified)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_proc</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
                <span class="n">new_proc</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">trait</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">trait</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">meta_forbidden</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">new_proc</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="c1"># set back old value</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">new_proc</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="n">node</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">new_proc</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">module_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s1">&#39;__init__.py&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">pipelines</span> <span class="o">=</span> <span class="p">[</span><span class="n">pipeline</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">nodes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                          <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
                <span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">module_name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
                <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
                <span class="n">pipelines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">ProcessIteration</span><span class="p">):</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">process</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
                <span class="n">nodes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                          <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">replace_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">replace_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pipeline</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">pipelines</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.py&#39;</span> \
            <span class="o">%</span> <span class="n">pipeline</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">save_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CAPSUL</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CAPSUL</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2023, Populse team &lt;support@brainvisa.info&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>