<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
    <title>CAPSUL &#8212; CAPSUL - Chain algorithm in pipelines and execute in many contexts</title>
  <!-- htmltitle is before nature.css - we use this hack to load bootstrap first -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../../../../_static/css/bootstrap.min.css" media="screen" />
  <link rel="stylesheet" href="../../../../_static/css/bootstrap-responsive.css"/>
  <link rel="icon" href="../../../../_static/capsul_logo.svg"/>

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=f0b81668" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=fd3f3429" />
    
    <script src="../../../../_static/documentation_options.js?v=983e91d6"></script>
    <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />

  <!-- sidebar -->
  
   
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../../../../_static/js/bootstrap.min.js" type="application/javascript"></script>

  <script type="application/javascript">
    $("div.buttonNext, div.buttonPrevious").hover(
       function () {
           $(this).css('background-color', '#FF9C34');
       },
       function () {
           $(this).css('background-color', '#A7D6E2');
       }
    );
    var bodywrapper = $('.bodywrapper');
    var sidebarbutton = $('#sidebarbutton');
    sidebarbutton.css({'height': '900px'});
  </script>

  <div class="header" style="display: inline; width: 80%; margin-left:10%;">
    <a href="../../../../index.html">
    <img src="../../../../_static/capsul_logo.svg" alt="Capsul logo" style="display: inline; height:4em;"/>
    </a >
    <div class="navbar" style="display: inline;">
      <ul>
        <li><a href="../../../../index.html">Home</a></li>
        <li><a href="../../../../installation.html">Installation</a></li>
        <li class="btn-li">
          <div class="btn-group">
            <a href="../../../../documentation.html">Documentation</a>
            <a class="btn dropdown-toggle" data-toggle="dropdown">
              <span class="caret"></span>
            </a>
            <ul class="dropdown-menu">
              <li class="link-title">CAPSUL</li>
              <li><a href="../../../../user_guide_tree/index.html">User guide</a></li>
              <li><a href="../../../../api/index.html">API</a></li>
            </ul>
          </div>
        </li>
        <li>
          <!-- form action="search.html" method="get" style="display: inline-block;"></form>
            <input type="text" class="search-header" name="q" placeholder="search documentation..." value=""></input>
            <button type="submit" >search</button>
          </form -->
          <form class="search_box" method="get" action="http://www.google.com/search" style="display: inline-block;">
            <input class="search-header" type="text" name="q" placeholder="search documentation..." />
            <input class="submit" type="image" src="../../../../_static/find_read.png" value="Search" />
            <input type="hidden" name="sitesearch" value="brainvisa.info/capsul" />
          </form>
        </li>
      </ul>
    </div> <!-- end navbar -->
  </div>


  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">CAPSUL</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../engine.html" accesskey="U">capsul.engine</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CAPSUL</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for capsul.engine.module.python</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39; Python configuration module for CAPSUL</span>

<span class="sd">This config module allows the customization of python executable and python path in process execution. It can (as every config module) assign specific config values for different environments (computing resources, typically).</span>

<span class="sd">Python configuration is slightly different from other config modules in the way that it cannot be handled during execution inside a python library: python executable and modules path have to be setup before starting python and loading modules. So the config here sometimes has to be prepared from client side and hard-coded in the job to run.</span>

<span class="sd">For this reason, what we call here &quot;python jobs&quot; have a special handling. &quot;python jobs&quot; are :class:`~capsul.process.process.Process` classes defining a :meth:`~capsul.process.process.Process._run_process` method, and not :meth:`~capsul.process.process.Process.get_commandline`. Processing are thus python functions or methods, and need the capsul library to run.</span>

<span class="sd">Python jobs are handled in workflow building (:mod:`capsul.pipeline.pipeline_workflow`), and jobs on engine side should not have to bother about it.</span>

<span class="sd">The python config module is not mandatory: if no specific configuration is needed, jobs are run using the python command from the path, following the client ``sys.executable`` short name (if the client runs ``/usr/bin/python3``, the engine will try to use ``python3`` from the ``PATH``.</span>

<span class="sd">The python config module is used optionally (if there is a config, it is used, otherwise no error is produced), and automatically for all jobs: no need to declare it in jobs :meth:`~capsul.process.process.Process.requirements` method.</span>

<span class="sd">Inside process execution, the module is otherwise handled like any other.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">capsul.engine</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>


<span class="k">def</span><span class="w"> </span><span class="nf">init_settings</span><span class="p">(</span><span class="n">capsul_engine</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">capsul_engine</span><span class="o">.</span><span class="n">settings</span> <span class="k">as</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">ensure_module_fields</span><span class="p">(</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
        <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;executable&#39;</span><span class="p">,</span>
              <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">,</span>
              <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Full path of the python executable&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;path&#39;</span><span class="p">,</span>
              <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;list_string&#39;</span><span class="p">,</span>
              <span class="n">description</span><span class="o">=</span><span class="s1">&#39;paths to prepend to sys.path&#39;</span><span class="p">),</span>
         <span class="p">])</span>


<div class="viewcode-block" id="activate_configurations">
<a class="viewcode-back" href="../../../../api/engine.html#capsul.engine.module.python.activate_configurations">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">activate_configurations</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Activate the python module from the global configurations</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">py_conf</span> <span class="o">=</span> <span class="n">capsul</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">configurations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capsul.engine.module.python&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">py_conf</span><span class="p">:</span>
        <span class="n">py_path</span> <span class="o">=</span> <span class="n">py_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">py_path</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">py_path</span> <span class="o">+</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">py_path</span><span class="p">]</span></div>


<div class="viewcode-block" id="check_notably_invalid_config">
<a class="viewcode-back" href="../../../../api/engine.html#capsul.engine.module.python.check_notably_invalid_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_notably_invalid_config</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks if the given module config is obviously invalid, for instance if a mandatory path is not filled</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    invalid: list</span>
<span class="sd">        list of invalid config keys</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">invalid</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;executable&#39;</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">invalid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">invalid</span></div>



<div class="viewcode-block" id="edition_widget">
<a class="viewcode-back" href="../../../../api/engine.html#capsul.engine.module.python.edition_widget">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">edition_widget</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">config_id</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Edition GUI for python config - see</span>
<span class="sd">    :class:`~capsul.qt_gui.widgets.settings_editor.SettingsEditor`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">soma.qt_gui.qt_backend</span><span class="w"> </span><span class="kn">import</span> <span class="n">Qt</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">soma.qt_gui.controller_widget</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScrollControllerWidget</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">soma.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">Controller</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">types</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">traits.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">traits</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="n">widget</span><span class="p">):</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">update_controller</span><span class="p">()</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">controller_widget</span><span class="o">.</span><span class="n">controller</span>
        <span class="k">with</span> <span class="n">widget</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">settings</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">config_id</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">environment</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;config_id&#39;</span><span class="p">:</span> <span class="n">config_id</span><span class="p">,</span>
                      <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">controller</span><span class="o">.</span><span class="n">path</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">controller</span><span class="o">.</span><span class="n">executable</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;executable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;executable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">executable</span>
            <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">new_config</span><span class="p">(</span><span class="n">config_id</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;executable&#39;</span><span class="p">):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="n">controller</span> <span class="o">=</span> <span class="n">Controller</span><span class="p">()</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s1">&#39;executable&#39;</span><span class="p">,</span>
                         <span class="n">traits</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Full path of the python executable&#39;</span><span class="p">))</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span>
                         <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Directory</span><span class="p">(),</span> <span class="p">[],</span>
                                     <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;paths to prepend to sys.path&#39;</span><span class="p">))</span>

    <span class="n">conf</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">select_configurations</span><span class="p">(</span>
        <span class="n">environment</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;python&#39;</span><span class="p">:</span> <span class="s1">&#39;any&#39;</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">conf</span><span class="p">:</span>
        <span class="n">controller</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;capsul.engine.module.python&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;executable&#39;</span><span class="p">,</span>
                                                   <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">)</span>
        <span class="n">controller</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;capsul.engine.module.python&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="n">widget</span> <span class="o">=</span> <span class="n">ScrollControllerWidget</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">live</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">accept</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">validate_config</span><span class="p">,</span> <span class="n">widget</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">widget</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">CAPSUL</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../engine.html" >capsul.engine</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CAPSUL</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, Populse team &lt;support@brainvisa.info&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>