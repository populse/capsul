<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
    <title>CAPSUL &#8212; CAPSUL - Chain algorithm in pipelines and execute in many contexts</title>
  <!-- htmltitle is before nature.css - we use this hack to load bootstrap first -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../../../_static/css/bootstrap.min.css" media="screen" />
  <link rel="stylesheet" href="../../../_static/css/bootstrap-responsive.css"/>
  <link rel="icon" href="../../../_static/capsul_logo.svg"/>

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=f0b81668" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
    
    <script src="../../../_static/documentation_options.js?v=4d935f96"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

  <!-- sidebar -->
  
   
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../../../_static/js/bootstrap.min.js" type="application/javascript"></script>

  <script type="application/javascript">
    $("div.buttonNext, div.buttonPrevious").hover(
       function () {
           $(this).css('background-color', '#FF9C34');
       },
       function () {
           $(this).css('background-color', '#A7D6E2');
       }
    );
    var bodywrapper = $('.bodywrapper');
    var sidebarbutton = $('#sidebarbutton');
    sidebarbutton.css({'height': '900px'});
  </script>

  <div class="header" style="display: inline; width: 80%; margin-left:10%;">
    <a href="../../../index.html">
    <img src="../../../_static/capsul_logo.svg" alt="Capsul logo" style="display: inline; height:4em;"/>
    </a >
    <div class="navbar" style="display: inline;">
      <ul>
        <li><a href="../../../index.html">Home</a></li>
        <li><a href="../../../installation.html">Installation</a></li>
        <li class="btn-li">
          <div class="btn-group">
            <a href="../../../documentation.html">Documentation</a>
            <a class="btn dropdown-toggle" data-toggle="dropdown">
              <span class="caret"></span>
            </a>
            <ul class="dropdown-menu">
              <li class="link-title">CAPSUL</li>
              <li><a href="../../../user_guide_tree/index.html">User guide</a></li>
              <li><a href="../../../api/index.html">API</a></li>
            </ul>
          </div>
        </li>
        <li>
          <!-- form action="search.html" method="get" style="display: inline-block;"></form>
            <input type="text" class="search-header" name="q" placeholder="search documentation..." value=""></input>
            <button type="submit" >search</button>
          </form -->
          <form class="search_box" method="get" action="http://www.google.com/search" style="display: inline-block;">
            <input class="search-header" type="text" name="q" placeholder="search documentation..." />
            <input class="submit" type="image" src="../../../_static/find_read.png" value="Search" />
            <input type="hidden" name="sitesearch" value="brainvisa.info/capsul" />
          </form>
        </li>
      </ul>
    </div> <!-- end navbar -->
  </div>


  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CAPSUL</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../engine.html" accesskey="U">capsul.engine</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CAPSUL</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for capsul.engine.settings</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This module provides classes to store CapsulEngine settings for several execution environment and choose a configuration for a given execution environment. Setting management in Capsul has several features that makes it different from classical ways to deal with configuration:</span>

<span class="sd">* CapsulEngine must be able to deal with several configurations for the same software. For instance, one can configure both SPM 8 and SPM 12 and choose later the one to use.</span>
<span class="sd">* A single pipeline may use various configurations of a software. For instance a pipeline could compare the results of SPM 8 and SPM 12.</span>
<span class="sd">* Settings definition must be modular. It must be possible to define possible settings values either in Capsul (for well known for instance) or in external modules that can be installed separately.</span>
<span class="sd">* Capsul must deal with module dependencies. For instance the settings of SPM may depends on the settings of Matlab. But this dependency exists only if a non standalone SPM version is used. Therefore, dependencies between modules may depends on settings values.</span>
<span class="sd">* CapsulEngine settings must provide the possibility to express a requirement on settings. For instance a process may require to have version of SPM greater or equal to 12.</span>
<span class="sd">* The configuration of a module can be defined for a specific execution environment. Settings must allow to deal with several executions environments (e.g. a local machine and a computing cluster). Each environment may have a different configuration (for instance the SPM installation directory is not the same on the local computer and on a computing cluster).</span>

<span class="sd">To implement all these features, it was necessary to have a settings storage system providing a query language to express requirements such as ``spm.version &gt;= 12``. Populse_db was thus chosen as the storage and query system for settings. Some of the settings API choices have been influenced by populse_db API.</span>

<span class="sd">CapsulEngine settings are organized in modules. Each module defines and documents the schema of values that can be set for its configuration. Typically, a module is dedicated to a software. For instance the module for SPM accepts confiurations containing a version (a string), an install directory (a string), a standalone/matlab flag (a boolean), etc. This schema is used to record configuration documents for the module. There can be several configuration documents per module. Each document corresponds to a full configuration of the module (for instance a document for SPM 8 configuration and another for SPM 12, or one for SPM 12 standalone and another for SPM 12 with matlab).</span>

<span class="sd">Settings cannot be used directly to configure the execution of a software. It is necessary to first select a single configuration document for each module. This configurations selection step is done by the :meth:`Settings.select_configurations` method.</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="c1">#</span>
<span class="c1"># Questions about settings</span>
<span class="c1"># How to automatically build a GUI to input settings values ?</span>
<span class="c1"># * default values</span>
<span class="c1"># * mandatory / optional settings</span>
<span class="c1"># * dependencies between settings</span>
<span class="c1">#</span>
<span class="c1"># all these were &quot;simple&quot; using Controllers but are in a way &quot;too free&quot; now,</span>
<span class="c1"># and &quot;too constrained&quot; in another way (table columns: not dicts or structures)</span>
<span class="c1">#</span>
<span class="c1"># config modules might provide validation functions (check consistency,</span>
<span class="c1"># completeness of config values), and maybe a Controller to build a GUI ?</span>
<span class="c1">#</span>
<span class="c1"># How to store additional data indirectly linked with settings values ?</span>
<span class="c1"># Some modules were using objects shared through StudyConfig.modules_data</span>
<span class="c1"># (or CapsulEngine).</span>
<span class="c1">#</span>
<span class="c1"># doc on modules activation / use ?</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">import</span> <span class="nn">sys</span>


<div class="viewcode-block" id="Settings">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.Settings">[docs]</a>
<span class="k">class</span> <span class="nc">Settings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Main class for the management of CapsulEngine settings. Since these</span>
<span class="sd">    settings are always stored in a populse_db database, it is necessary to</span>
<span class="sd">    activate a settings session in order to read or modify settings. This is</span>
<span class="sd">    done by using a with clause::</span>

<span class="sd">        from capsul.api import capsul_engine</span>

<span class="sd">        # Create a CapsulEngine</span>
<span class="sd">        ce = capsul_engine()</span>
<span class="sd">        with ce.settings as settings:</span>
<span class="sd">            # Read or modify settings here</span>
<span class="sd">            conf = settings.new_config(&#39;spm&#39;, &#39;global&#39;,</span>
<span class="sd">                                       {&#39;version&#39;: &#39;12&#39;, &#39;standalone&#39;: True})</span>
<span class="sd">            # modify value</span>
<span class="sd">            conf.directory = &#39;/usr/local/spm12-standalone&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">global_environment</span> <span class="o">=</span> <span class="s1">&#39;global&#39;</span>
    <span class="n">collection_prefix</span> <span class="o">=</span> <span class="s1">&#39;settings/&#39;</span>
    <span class="n">environment_field</span> <span class="o">=</span> <span class="s1">&#39;config_environment&#39;</span>
    <span class="n">config_id_field</span> <span class="o">=</span> <span class="s1">&#39;config_id&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">populse_db</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a settings instance using the given populse_db instance</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populse_db</span> <span class="o">=</span> <span class="n">populse_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_notifiers</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Starts a session to read or write settings</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populse_db</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">SettingsSession</span><span class="p">(</span><span class="n">dbs</span><span class="p">,</span> <span class="n">module_notifiers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_notifiers</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populse_db</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="Settings.module_name">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.Settings.module_name">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">module_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a complete module name (which must be a valid Python module</span>
<span class="sd">        name) given a possibly abbreviated module name. This method must</span>
<span class="sd">        be used whenever a module name is written by a user (for instance</span>
<span class="sd">        in a configuration file.</span>
<span class="sd">        This method add the prefix `&#39;capsul.engine.module.&#39;` if the module</span>
<span class="sd">        name does not contain a dot.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module_name</span><span class="p">:</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="s1">&#39;capsul.engine.module.&#39;</span> <span class="o">+</span> <span class="n">module_name</span>
        <span class="k">return</span> <span class="n">module_name</span></div>

    
<div class="viewcode-block" id="Settings.select_configurations">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.Settings.select_configurations">[docs]</a>
    <span class="k">def</span> <span class="nf">select_configurations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">uses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">check_invalid_mods</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Select a configuration for a given environment. A configuration is</span>
<span class="sd">        a dictionary whose keys are module names and values are</span>
<span class="sd">        configuration documents. The returned set of configuration per module</span>
<span class="sd">        can be activaded with `capsul.api.activate_configuration()`.</span>
<span class="sd">        </span>
<span class="sd">        The `uses` parameter determine which modules</span>
<span class="sd">        must be included in the configuration. If not given, this method </span>
<span class="sd">        considers all configurations for every module defined in settings.</span>
<span class="sd">        This parameter is a dictionary whose keys are a module name and</span>
<span class="sd">        values are populse_db queries used to select module.</span>
<span class="sd">        </span>
<span class="sd">        The environment parameter defines the execution environment in which</span>
<span class="sd">        the configurations will be used. For each module, configurations are</span>
<span class="sd">        filtered with the query. First, values are searched in the given</span>
<span class="sd">        environment and, if no result is found, the `&#39;global&#39;` environment</span>
<span class="sd">        (the value defined in `Settings.global_environment`) is used.</span>
<span class="sd">        </span>
<span class="sd">        If `check_invalid_mods` is True, then each selected config module is</span>
<span class="sd">        checked for missing values and discarded if there are.</span>

<span class="sd">        example</span>
<span class="sd">        -------</span>
<span class="sd">        To select a SPM version greater than 8 for an environment called</span>
<span class="sd">        `&#39;my_environment&#39;` one could use the following code::</span>

<span class="sd">            config = ce.select_configurations(&#39;my_environment&#39;,</span>
<span class="sd">                                              uses={&#39;spm&#39;: &#39;version &gt; 8&#39;})</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">configurations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="bp">self</span> <span class="k">as</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">uses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">uses</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">collection_name</span> 
                                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> 
                                   <span class="n">settings</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">get_collections</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">collection_prefix</span><span class="p">):</span>
                        <span class="n">module_name</span> <span class="o">=</span> \
                            <span class="n">collection</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">collection_prefix</span><span class="p">):]</span>
                        <span class="n">uses</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ALL&#39;</span>
            <span class="n">uses_stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">uses</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="k">while</span> <span class="n">uses_stack</span><span class="p">:</span>
                <span class="n">module</span><span class="p">,</span> <span class="n">query</span> <span class="o">=</span> <span class="n">uses_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># append environment to config_id if it is given in the filter</span>
                <span class="k">if</span> <span class="s1">&#39;config_id==&quot;&#39;</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;config_id==&quot;&#39;</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">environment</span><span class="p">,</span> <span class="n">query</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>

                <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">configurations</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">configurations</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;capsul_engine&#39;</span><span class="p">,</span> 
                                          <span class="p">{})</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;uses&#39;</span><span class="p">,</span> 
                                                         <span class="p">{})[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>
                <span class="n">selected_config</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">query_env</span> <span class="o">=</span> <span class="n">environment</span>
                <span class="n">full_query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> == &quot;</span><span class="si">%s</span><span class="s1">&quot; AND (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">Settings</span><span class="o">.</span><span class="n">environment_field</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="p">(</span>
                        <span class="s1">&#39;ALL&#39;</span> <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span> <span class="k">else</span> <span class="n">query</span><span class="p">))</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">collection_prefix</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">):</span>
                    <span class="n">docs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">filter_documents</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> 
                                                               <span class="n">full_query</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="n">check_invalid_mods</span><span class="p">:</span>
                    <span class="c1"># filter out invalid configs</span>
                    <span class="n">doc_t</span> <span class="o">=</span> <span class="n">docs</span>
                    <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">doc_t</span><span class="p">:</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>
                        <span class="n">invalid</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s1">&#39;check_notably_invalid_config&#39;</span><span class="p">):</span>
                            <span class="n">invalid</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">check_notably_invalid_config</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">selected_config</span> <span class="o">=</span> <span class="n">docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span><span class="p">:</span>
                        <span class="n">selected_config</span> <span class="o">=</span> <span class="n">docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s1">&#39;Cannot create configurations &#39;</span>
                            <span class="s1">&#39;for environment &quot;</span><span class="si">%s</span><span class="s1">&quot; because settings returned &#39;</span>
                            <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> instances for module </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">environment</span><span class="p">,</span> 
                                                            <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">),</span> <span class="n">module</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">full_query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> == &quot;</span><span class="si">%s</span><span class="s1">&quot; AND (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">environment_field</span><span class="p">,</span>
                                                          <span class="n">Settings</span><span class="o">.</span><span class="n">global_environment</span><span class="p">,</span>
                                                          <span class="p">(</span><span class="s1">&#39;ALL&#39;</span> <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span> 
                                                           <span class="k">else</span> <span class="n">query</span><span class="p">))</span>
                    <span class="n">query_env</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">global_environment</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">):</span>
                        <span class="n">docs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">filter_documents</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> 
                                                                   <span class="n">full_query</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">if</span> <span class="n">check_invalid_mods</span><span class="p">:</span>
                        <span class="c1"># filter out invalid configs</span>
                        <span class="n">doc_t</span> <span class="o">=</span> <span class="n">docs</span>
                        <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">doc_t</span><span class="p">:</span>
                            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>
                            <span class="n">invalid</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s1">&#39;check_notably_invalid_config&#39;</span><span class="p">):</span>
                                <span class="n">invalid</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">check_notably_invalid_config</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">selected_config</span> <span class="o">=</span> <span class="n">docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">query</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span><span class="p">:</span>
                            <span class="n">selected_config</span> <span class="o">=</span> <span class="n">docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s1">&#39;Cannot create &#39;</span>
                                <span class="s1">&#39;configurations for environment &quot;</span><span class="si">%s</span><span class="s1">&quot; because &#39;</span>
                                <span class="s1">&#39;global settings returned </span><span class="si">%d</span><span class="s1"> instances for &#39;</span>
                                <span class="s1">&#39;module </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_env</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">),</span> <span class="n">module</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">selected_config</span><span class="p">:</span>
                    <span class="c1"># Remove values that are None</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">selected_config</span><span class="p">,</span> <span class="s1">&#39;_items&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># older populse_db 1.x</span>
                        <span class="n">items</span> <span class="o">=</span> <span class="n">selected_config</span><span class="o">.</span><span class="n">items</span>
                    <span class="n">selected_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">items</span><span class="p">())</span>
                    <span class="k">if</span> <span class="s1">&#39;config_id&#39;</span> <span class="ow">in</span> <span class="n">selected_config</span><span class="p">:</span>
                        <span class="n">selected_config</span><span class="p">[</span><span class="s1">&#39;config_id&#39;</span><span class="p">]</span> \
                            <span class="o">=</span> <span class="n">selected_config</span><span class="p">[</span><span class="s1">&#39;config_id&#39;</span><span class="p">][</span>
                                <span class="p">:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">query_env</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">items</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">selected_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">configurations</span><span class="p">[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_config</span>
                    <span class="n">python_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
                    <span class="n">config_dependencies</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">python_module</span><span class="p">,</span> 
                                                  <span class="s1">&#39;config_dependencies&#39;</span><span class="p">,</span> 
                                                  <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">config_dependencies</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">config_dependencies</span><span class="p">(</span><span class="n">selected_config</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                            <span class="n">uses_stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                                <span class="p">[(</span><span class="n">Settings</span><span class="o">.</span><span class="n">module_name</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

        <span class="k">return</span> <span class="n">configurations</span></div>


    <span class="k">def</span> <span class="nf">export_config_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_environments</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">environment</span> <span class="o">=</span> <span class="p">[</span><span class="n">environment</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">modules</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">collection_name</span>
                               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                               <span class="n">session</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">get_collections</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">collection_prefix</span><span class="p">):</span>
                    <span class="n">module_name</span> <span class="o">=</span> \
                        <span class="n">collection</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">collection_prefix</span><span class="p">):]</span>
                    <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="n">environment</span><span class="p">:</span>
                <span class="n">env_conf</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
                    <span class="n">mod_conf</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">configs</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
                        <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
                        <span class="n">doc</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span>
                            <span class="n">session</span><span class="o">.</span><span class="n">collection_name</span><span class="p">(</span><span class="n">module</span><span class="p">),</span> <span class="nb">id</span><span class="p">)</span>
                        <span class="n">items</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">_items</span><span class="p">())</span>
                        <span class="k">if</span> <span class="s1">&#39;config_id&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                            <span class="n">items</span><span class="p">[</span><span class="s1">&#39;config_id&#39;</span><span class="p">]</span> \
                                <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="s1">&#39;config_id&#39;</span><span class="p">][:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">mod_conf</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span>
                    <span class="k">if</span> <span class="n">mod_conf</span><span class="p">:</span>
                        <span class="n">env_conf</span><span class="p">[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_conf</span>

                <span class="n">env_conf</span><span class="p">[</span><span class="s1">&#39;capsul_engine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uses&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">m</span><span class="p">:</span> <span class="s1">&#39;ALL&#39;</span>
                                                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">}}</span>

                <span class="n">conf</span><span class="p">[</span><span class="n">env</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_conf</span>

        <span class="k">return</span> <span class="n">conf</span>


<div class="viewcode-block" id="Settings.import_configs">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.Settings.import_configs">[docs]</a>
    <span class="k">def</span> <span class="nf">import_configs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">,</span> <span class="n">cont_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Import config values from a dictionary as given by</span>
<span class="sd">        :meth:`select_configurations`.</span>

<span class="sd">        Compared to :meth:`CapsulEngine.import_configs` this method (at</span>
<span class="sd">        :class:`Settings` level) does not load the required modules.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capsul_engine&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uses&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">with</span> <span class="bp">self</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
                <span class="n">mod_dict</span> <span class="o">=</span> <span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="n">mod_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;config_id&#39;</span> <span class="ow">in</span> <span class="n">mod_dict</span><span class="p">:</span>
                        <span class="c1"># select_configurations() shape: 1 config per module</span>
                        <span class="n">mod_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">mod_dict</span><span class="p">[</span><span class="s1">&#39;config_id&#39;</span><span class="p">]:</span> <span class="n">mod_dict</span><span class="p">}</span>
                    <span class="c1"># otherwise several config are indexed by their config_id</span>
                    <span class="k">for</span> <span class="n">config_id</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">mod_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">conf</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">config</span><span class="p">(</span>
                            <span class="n">module</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="s1">&#39;config_id == &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span>
                            <span class="n">config_id</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">conf</span><span class="p">:</span>
                                <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                          <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;config_id&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;config_environment&#39;</span><span class="p">)}</span>
                                <span class="n">conf</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">session</span><span class="o">.</span><span class="n">new_config</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">cont_on_error</span><span class="p">:</span>
                                <span class="k">raise</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Capsul config import fails for &#39;</span>
                                  <span class="s1">&#39;environment:&#39;</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="s1">&#39;, module:&#39;</span><span class="p">,</span>
                                  <span class="n">module</span><span class="p">,</span> <span class="s1">&#39;, config:&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span></div>


<div class="viewcode-block" id="Settings.get_all_environments">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.Settings.get_all_environments">[docs]</a>
    <span class="k">def</span> <span class="nf">get_all_environments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get all environment values in the database</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="bp">self</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">get_all_environments</span><span class="p">()</span></div>
</div>

    
    
<div class="viewcode-block" id="SettingsSession">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.SettingsSession">[docs]</a>
<span class="k">class</span> <span class="nc">SettingsSession</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Settings use/modifiction session, returned by &quot;with settings as session:&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">populse_session</span><span class="p">,</span> <span class="n">module_notifiers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        SettingsSession are created with Settings.__enter__ using a `with`</span>
<span class="sd">        statement.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span> <span class="o">=</span> <span class="n">populse_session</span>
        <span class="k">if</span> <span class="n">module_notifiers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_notifiers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_notifiers</span> <span class="o">=</span> <span class="n">module_notifiers</span>

<div class="viewcode-block" id="SettingsSession.collection_name">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.SettingsSession.collection_name">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">collection_name</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the name of the populse_db collection corresponding to a</span>
<span class="sd">        settings module. The result is the full name of the module </span>
<span class="sd">        prefixed by Settings.collection_prefix (i.e. `&#39;settings/&#39;`).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">Settings</span><span class="o">.</span><span class="n">module_name</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">collection_prefix</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">collection</span></div>

    
<div class="viewcode-block" id="SettingsSession.ensure_module_fields">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.SettingsSession.ensure_module_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">ensure_module_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Make sure that the given module exists in settings and create the given fields if they do not exist. `fields` is a list of dictionaries with three items:</span>
<span class="sd">        - name: the name of the key</span>
<span class="sd">        - type: the data type of the field (in populse_db format)</span>
<span class="sd">        - description: the documentation of the field</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">Settings</span><span class="o">.</span><span class="n">config_id_field</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> 
                                <span class="n">Settings</span><span class="o">.</span><span class="n">environment_field</span><span class="p">,</span> 
                                <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">field_type</span><span class="o">=</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                                    <span class="n">description</span><span class="o">=</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">collection</span></div>

    
<div class="viewcode-block" id="SettingsSession.new_config">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.SettingsSession.new_config">[docs]</a>
    <span class="k">def</span> <span class="nf">new_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates a new configuration document for a module in the given </span>
<span class="sd">        environment. Values is a dictionary used to set values for the </span>
<span class="sd">        document. The document mut have a unique string identifier in </span>
<span class="sd">        the `Settings.config_id_field` (i.e. `&#39;config_id&#39;`), if None is</span>
<span class="sd">        given in `values` a unique random value is created (with </span>
<span class="sd">        `uuid.uuid4()`).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">document</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">Settings</span><span class="o">.</span><span class="n">environment_field</span><span class="p">:</span> <span class="n">environment</span><span class="p">}</span>
        <span class="n">document</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">config_id_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">document</span><span class="p">[</span><span class="n">Settings</span><span class="o">.</span><span class="n">config_id_field</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">SettingsConfig</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span>
            <span class="n">notifiers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_notifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">module_name</span><span class="p">(</span><span class="n">module</span><span class="p">),</span>
                                                <span class="p">[]))</span>
        <span class="n">config</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">config</span></div>


<div class="viewcode-block" id="SettingsSession.remove_config">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.SettingsSession.remove_config">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">config_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Removes a configuration (document in the database) for a given module /</span>
<span class="sd">        environment, idenfified by its `Settings.config_id_field` value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config_id</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">remove_document</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span></div>


<div class="viewcode-block" id="SettingsSession.configs">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.SettingsSession.configs">[docs]</a>
    <span class="k">def</span> <span class="nf">configs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a generator that iterates over all configuration</span>
<span class="sd">        documents created for the given module and environment.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">selection</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;config_id&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;config_id&#39;</span><span class="p">)</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">selection</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s%s</span><span class="s1">&#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">[:</span><span class="n">x</span><span class="p">],</span> <span class="n">environment</span><span class="p">,</span>
                                            <span class="n">selection</span><span class="p">[</span><span class="n">x</span><span class="p">:])</span>
                <span class="n">full_query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> == &quot;</span><span class="si">%s</span><span class="s1">&quot; AND (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">Settings</span><span class="o">.</span><span class="n">environment_field</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>
                <span class="n">docs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">filter_documents</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">full_query</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">docs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">filter_documents</span><span class="p">(</span>
                    <span class="n">collection</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">==&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">environment_field</span><span class="p">,</span> <span class="n">environment</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">Settings</span><span class="o">.</span><span class="n">config_id_field</span><span class="p">]</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">SettingsConfig</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span>
                    <span class="n">notifiers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module_notifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">module_name</span><span class="p">(</span>
                        <span class="n">module</span><span class="p">),</span> <span class="p">[]))</span></div>


<div class="viewcode-block" id="SettingsSession.config">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.SettingsSession.config">[docs]</a>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">any</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Selects configurations (like in :meth:`congigs`) and ensures at most</span>
<span class="sd">        one one is selected</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        module: str</span>
<span class="sd">            module name</span>
<span class="sd">        environment: str</span>
<span class="sd">            environment id (&#39;global&#39; etc)</span>
<span class="sd">        selection: str (optional)</span>
<span class="sd">            to select the configuration</span>
<span class="sd">        any: bool (optional)</span>
<span class="sd">            When more than one config is found, if ``any`` is True (default),</span>
<span class="sd">            return any of them (the first one). If ``any`` is False, return</span>
<span class="sd">            None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        config: SettingsConfig instance or None</span>
<span class="sd">            None if no matching config is found or more than one if any is</span>
<span class="sd">            False</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">selection</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="SettingsSession.get_all_environments">
<a class="viewcode-back" href="../../../api/engine.html#capsul.engine.settings.SettingsSession.get_all_environments">[docs]</a>
    <span class="k">def</span> <span class="nf">get_all_environments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get all environment values in the database</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># TODO FIXME</span>
        <span class="c1"># this function uses low-level SQL requests on the sql engine of</span>
        <span class="c1"># populse_db 2, because I don&#39;t know how to perform requests with the</span>
        <span class="c1"># &quot;DISTINCT&quot; keyword using the high level requests language. It will</span>
        <span class="c1"># not work using populse_db 1 nor using another (non-SQL)</span>
        <span class="c1"># implementation of the database engine.</span>
        <span class="n">environments</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">collection_name</span>
                           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">get_collections</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">collection_prefix</span><span class="p">):</span>
                <span class="c1">#collection = collection[len(Settings.collection_prefix):]</span>
                <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">collection_table</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span>
                <span class="c1">#full_query = &#39;%s == &quot;%s&quot;&#39; % (</span>
                    <span class="c1">#Settings.environment_field, environment)</span>
                <span class="c1">#docs = self._dbs.filter_documents(collection, full_query)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT DISTINCT </span><span class="si">%s</span><span class="s1"> FROM &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> \
                    <span class="o">%</span> <span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">environment_field</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">environments</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">environments</span></div>
</div>


<span class="k">class</span> <span class="nc">SettingsConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">populse_session</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span>
                 <span class="n">notifiers</span><span class="o">=</span><span class="p">[]):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SettingsConfig</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;_dbs&#39;</span><span class="p">,</span> <span class="n">populse_session</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SettingsConfig</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;_collection&#39;</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SettingsConfig</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;_environment&#39;</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SettingsConfig</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SettingsConfig</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;_notifiers&#39;</span><span class="p">,</span> <span class="n">notifiers</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">SettingsConfig</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">),</span>
                        <span class="nb">super</span><span class="p">(</span><span class="n">SettingsConfig</span><span class="p">,</span>
                              <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s1">&#39;_environment&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="c1"># notify change for listeners</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span> <span class="s1">&#39;_environment&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SettingsConfig</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="p">,</span>
                                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environment</span><span class="p">),</span>
                                    <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;config_id&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_environment</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">set_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environment</span><span class="p">)</span>
        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span>
                                     <span class="n">fields</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">as_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mod_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">o</span> <span class="o">!=</span> <span class="n">v</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">mod_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbs</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">mod_values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mod_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notifiers</span><span class="p">:</span>
            <span class="n">notifier</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CAPSUL</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../engine.html" >capsul.engine</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CAPSUL</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2023, Populse team &lt;support@brainvisa.info&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>