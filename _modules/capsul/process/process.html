<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
    <title>CAPSUL &#8212; CAPSUL - Chain algorithm in pipelines and execute in many contexts</title>
  <!-- htmltitle is before nature.css - we use this hack to load bootstrap first -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../../../_static/css/bootstrap.min.css" media="screen" />
  <link rel="stylesheet" href="../../../_static/css/bootstrap-responsive.css"/>
  <link rel="icon" href="../../../_static/capsul_logo.svg"/>

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=f0b81668" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
    
    <script src="../../../_static/documentation_options.js?v=983e91d6"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

  <!-- sidebar -->
  
   
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../../../_static/js/bootstrap.min.js" type="application/javascript"></script>

  <script type="application/javascript">
    $("div.buttonNext, div.buttonPrevious").hover(
       function () {
           $(this).css('background-color', '#FF9C34');
       },
       function () {
           $(this).css('background-color', '#A7D6E2');
       }
    );
    var bodywrapper = $('.bodywrapper');
    var sidebarbutton = $('#sidebarbutton');
    sidebarbutton.css({'height': '900px'});
  </script>

  <div class="header" style="display: inline; width: 80%; margin-left:10%;">
    <a href="../../../index.html">
    <img src="../../../_static/capsul_logo.svg" alt="Capsul logo" style="display: inline; height:4em;"/>
    </a >
    <div class="navbar" style="display: inline;">
      <ul>
        <li><a href="../../../index.html">Home</a></li>
        <li><a href="../../../installation.html">Installation</a></li>
        <li class="btn-li">
          <div class="btn-group">
            <a href="../../../documentation.html">Documentation</a>
            <a class="btn dropdown-toggle" data-toggle="dropdown">
              <span class="caret"></span>
            </a>
            <ul class="dropdown-menu">
              <li class="link-title">CAPSUL</li>
              <li><a href="../../../user_guide_tree/index.html">User guide</a></li>
              <li><a href="../../../api/index.html">API</a></li>
            </ul>
          </div>
        </li>
        <li>
          <!-- form action="search.html" method="get" style="display: inline-block;"></form>
            <input type="text" class="search-header" name="q" placeholder="search documentation..." value=""></input>
            <button type="submit" >search</button>
          </form -->
          <form class="search_box" method="get" action="http://www.google.com/search" style="display: inline-block;">
            <input class="search-header" type="text" name="q" placeholder="search documentation..." />
            <input class="submit" type="image" src="../../../_static/find_read.png" value="Search" />
            <input type="hidden" name="sitesearch" value="brainvisa.info/capsul" />
          </form>
        </li>
      </ul>
    </div> <!-- end navbar -->
  </div>


  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CAPSUL</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CAPSUL</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for capsul.process.process</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39; Process main class and infrastructure</span>

<span class="sd">Classes</span>
<span class="sd">-------</span>

<span class="sd">.. currentmodule:: capsul.process.process</span>

<span class="sd">:class:`Process`</span>
<span class="sd">++++++++++++++++</span>
<span class="sd">:class:`FileCopyProcess`</span>
<span class="sd">++++++++++++++++++++++++</span>
<span class="sd">:class:`InteractiveProcess`</span>
<span class="sd">+++++++++++++++++++++++++++</span>
<span class="sd">:class:`NipypeProcess`</span>
<span class="sd">++++++++++++++++++++++</span>
<span class="sd">:class:`ProcessMeta`</span>
<span class="sd">++++++++++++++++++++</span>
<span class="sd">:class:`ProcessResult`</span>
<span class="sd">++++++++++++++++++++++</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="c1"># System import</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">socket</span><span class="w"> </span><span class="kn">import</span> <span class="n">getfqdn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">soma.subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">six</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

<span class="c1"># Define the logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Trait import</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">traits.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">Directory</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">File</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">traits.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseTraitHandler</span>

<span class="c1"># Soma import</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">soma.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">Controller</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">soma.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">trait_ids</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">soma.controller.trait_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_trait_value_defined</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">soma.controller.trait_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_trait_pathname</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">soma.controller.trait_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_trait_desc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">soma.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">json_utils</span>

<span class="c1"># Capsul import</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">capsul.utils.version_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_tool_version</span>


<div class="viewcode-block" id="ProcessMeta">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.ProcessMeta">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ProcessMeta</span><span class="p">(</span><span class="n">Controller</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Class used to complete a process docstring</span>

<span class="sd">    Use a class and not a function for inheritance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ProcessMeta.complement_doc">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.ProcessMeta.complement_doc">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">complement_doc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">docstr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; complement the process docstring</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">docstring</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># we have to indent the note properly so that the docstring is</span>
        <span class="c1"># properly displayed, and correctly processed by sphinx</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">docstring</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">lstrip</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lstrip</span><span class="p">:</span>  <span class="c1"># empty lines do not influence indent</span>
                <span class="k">continue</span>
            <span class="n">lindent</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">indent</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">lindent</span> <span class="o">&lt;</span> <span class="n">indent</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="n">lindent</span>
        <span class="k">if</span> <span class="n">indent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Complete the docstring</span>
        <span class="n">docstring</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.. note::&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    * Type &#39;</span><span class="si">{0}</span><span class="s2">.help()&#39; for a full description of &quot;</span>
            <span class="s2">&quot;this process parameters.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
            <span class="s2">&quot;    * Type &#39;&lt;</span><span class="si">{0}</span><span class="s2">&gt;.get_input_spec()&#39; for a full description of &quot;</span>
            <span class="s2">&quot;this process input trait types.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
            <span class="s2">&quot;    * Type &#39;&lt;</span><span class="si">{0}</span><span class="s2">&gt;.get_output_spec()&#39; for a full description of &quot;</span>
            <span class="s2">&quot;this process output trait types.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
            <span class="s2">&quot;&quot;</span>
        <span class="p">]]</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="n">mcls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to print the full help.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mcls: meta class (mandatory)</span>
<span class="sd">            a meta class.</span>
<span class="sd">        name: str (mandatory)</span>
<span class="sd">            the process class name.</span>
<span class="sd">        bases: tuple (mandatory)</span>
<span class="sd">            the direct base classes.</span>
<span class="sd">        attrs: dict (mandatory)</span>
<span class="sd">            a dictionary with the class attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Update the class docstring with the full process help</span>
        <span class="n">docstring</span> <span class="o">=</span> <span class="n">ProcessMeta</span><span class="o">.</span><span class="n">complement_doc</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__doc__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;__doc__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">docstring</span>

        <span class="c1"># Find all traits definitions in the process class and ensure that</span>
        <span class="c1"># it has a boolean value for attributes &quot;output&quot; and &quot;optional&quot;.</span>
        <span class="c1"># If no value is given at construction, False will be used.</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">possible_trait_definition</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">possible_trait_definition</span><span class="p">,</span> <span class="n">BaseTraitHandler</span><span class="p">):</span>
                <span class="n">possible_trait_definition</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> \
                    <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">possible_trait_definition</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
                <span class="n">possible_trait_definition</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;optional&#39;</span><span class="p">]</span> \
                    <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">possible_trait_definition</span><span class="o">.</span><span class="n">optional</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ProcessMeta</span><span class="p">,</span> <span class="n">mcls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span>
            <span class="n">mcls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span></div>



<div class="viewcode-block" id="Process">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Process</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">ProcessMeta</span><span class="p">,</span> <span class="n">Controller</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A process is an atomic component that contains a processing.</span>

<span class="sd">    A process is typically an object with typed parameters, and an execution</span>
<span class="sd">    function. Parameters are described using Enthought</span>
<span class="sd">    `traits &lt;http://docs.enthought.com/traits/&gt;`_ through Soma-Base</span>
<span class="sd">    :somabase:`Controller &lt;api.html#soma.controller.controller.Controller&gt;`</span>
<span class="sd">    base class.</span>

<span class="sd">    In addition to describing its parameters, a Process must implement its</span>
<span class="sd">    execution function, either through a python method, by overloading</span>
<span class="sd">    :meth:`_run_process`, or through a commandline execution, by overloading</span>
<span class="sd">    :meth:`get_commandline`. The second way allows to run on a remote</span>
<span class="sd">    processing machine which has not necessary capsul, nor python, installed.</span>

<span class="sd">    Parameters are declared or queried using the traits API, and their values</span>
<span class="sd">    are in the process instance variables:</span>

<span class="sd">    ::</span>

<span class="sd">        from __future__ import print_function</span>
<span class="sd">        from capsul.api import Process</span>
<span class="sd">        import traits.api as traits</span>

<span class="sd">        class MyProcess(Process):</span>

<span class="sd">            # a class trait</span>
<span class="sd">            param1 = traits.Str(&#39;def_param1&#39;)</span>

<span class="sd">            def __init__(self):</span>
<span class="sd">                super(MyProcess, self).__init__()</span>
<span class="sd">                # declare an input param</span>
<span class="sd">                self.add_trait(&#39;param2&#39;, traits.Int())</span>
<span class="sd">                # declare an output param</span>
<span class="sd">                self.add_trait(&#39;out_param&#39;, traits.File(output=True))</span>

<span class="sd">            def _run_process(self):</span>
<span class="sd">                with open(self.out_param, &#39;w&#39;) as f:</span>
<span class="sd">                    print(&#39;param1:&#39;, self.param1, file=f)</span>
<span class="sd">                    print(&#39;param2:&#39;, self.param2, file=f)</span>

<span class="sd">        # run it with parameters</span>
<span class="sd">        MyProcess()(param2=12, out_param=&#39;/tmp/log.txt&#39;)</span>

<span class="sd">    **Note about the File and Directory traits**</span>

<span class="sd">    The :class:`~traits.trait_types.File` trait type represents a file</span>
<span class="sd">    parameter. A file is actually two things: a filename (string), and the file itself (on the filesystem). For an input it is OK not to distinguish them, but for an output, there are two different cases:</span>

<span class="sd">    * the file (on the filesystem) is an output, but the filename (string) is</span>
<span class="sd">      given as an input: this is the classical &quot;commandline&quot; behavior, when we</span>
<span class="sd">      tell the program where it should write its output file.</span>
<span class="sd">    * the file is an output, and the filename is also an output: this is rather a</span>
<span class="sd">      &quot;function return value&quot; behavior: the process determines internally where</span>
<span class="sd">      it should write the file, and tells as an output where it did.</span>

<span class="sd">    To distinguish these two cases, in Capsul we normally add in the</span>
<span class="sd">    :class:`~traits.trait_types.File` or :class:`~traits.trait_types.Directory`</span>
<span class="sd">    trait a property ``input_filename`` which is True when the filename is an</span>
<span class="sd">    input, and False when the filename is an output::</span>

<span class="sd">        self.add_trait(&#39;out_file&#39;,</span>
<span class="sd">                       traits.File(output=True, input_filename=False))</span>

<span class="sd">    However, as most of our processes are based on the &quot;commandline behavior&quot;</span>
<span class="sd">    (the filename is an input) and we often forget to specify the</span>
<span class="sd">    ``input_filename`` parameter, the default is the &quot;filename is an input&quot;</span>
<span class="sd">    behavior, when not specified.</span>

<span class="sd">    **Attributes**</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name: str</span>
<span class="sd">        the class name.</span>
<span class="sd">    id: str</span>
<span class="sd">        the string description of the class location (ie., module.class).</span>
<span class="sd">    log_file: str (default None)</span>
<span class="sd">        if None, the log will be generated in the current directory</span>
<span class="sd">        otherwise it will be written in log_file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize the Process class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Inheritance</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Initialize the process identifiers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Parameter to store which tools will be used dusring the processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">versions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;capsul&quot;</span><span class="p">:</span> <span class="n">get_tool_version</span><span class="p">(</span><span class="s2">&quot;capsul&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Initialize the log file name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">study_config</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">default_values</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;default_values&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default_values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_values</span> <span class="o">=</span> <span class="n">default_values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_values</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Remove the _weakref attribute eventually set by </span>
<span class="sd">        soma.utils.weak_proxy because it prevents Process instance</span>
<span class="sd">        from being used with pickle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>
        <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_weakref&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_user_traits&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__doc__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;study_config&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>
    
<div class="viewcode-block" id="Process.add_trait">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.add_trait">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_trait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure that trait.output and trait.optional are set to a</span>
<span class="sd">        boolean value before calling parent class add_trait.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;_metadata&quot;</span> <span class="ow">in</span> <span class="n">trait</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">trait</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trait</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
            <span class="n">trait</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;optional&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">optional</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trait</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
            <span class="n">trait</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">optional</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">trait</span><span class="p">)</span></div>

        
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to execute the Process.</span>

<span class="sd">        Keyword arguments may be passed to set process parameters.</span>
<span class="sd">        This in turn will allow calling the process like a standard</span>
<span class="sd">        python function.</span>
<span class="sd">        In such case keyword arguments are set in the process in</span>
<span class="sd">        addition to those already set before the call.</span>

<span class="sd">        Raise a TypeError if a keyword argument do not match with a</span>
<span class="sd">        process trait name.</span>

<span class="sd">        .. note:</span>

<span class="sd">            This method must not modify the class attributes in order</span>
<span class="sd">            to be able to perform smart caching.</span>

<span class="sd">        .. note:</span>

<span class="sd">            This method should **not** be overloaded by Process subclasses to</span>
<span class="sd">            perform actual processing. Instead, either the</span>
<span class="sd">            :meth:`_run_process` method or the :meth:`get_commandline` method</span>
<span class="sd">            should be overloaded.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs: dict (optional)</span>
<span class="sd">            should correspond to the declared parameter traits.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results:  ProcessResult object</span>
<span class="sd">            contains all execution information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Execute the process</span>
        <span class="n">returncode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">returncode</span>


<div class="viewcode-block" id="Process.run">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Obsolete: use self.__call__ instead</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    
    <span class="c1">####################################################################</span>
    <span class="c1"># Private methods</span>
    <span class="c1">####################################################################</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs the processings when the instance is called.</span>

<span class="sd">        Either this _run_process() or :meth:`get_commandline` must be</span>
<span class="sd">        defined in derived classes.</span>

<span class="sd">        Note that _run_process() is called as a python function, on a Process</span>
<span class="sd">        instance. When using remote processing (cluster for instance), this</span>
<span class="sd">        means that the commandline which will run needs to be able to re-</span>
<span class="sd">        instantiate the same process: the process thus has to be stored in a</span>
<span class="sd">        file or python module which can be accessed from the remote machine,</span>
<span class="sd">        and python / capsul correctly installed and available on it.</span>

<span class="sd">        :meth:`get_commandline` at the contrary, can implement commandlines</span>
<span class="sd">        which are completely independent from Capsul, and from python.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If both methods are not defined in the derived class a</span>
<span class="sd">            NotImplementedError error is raised.</span>

<span class="sd">            On the other side, if both methods are overloaded, the process</span>
<span class="sd">            behavior in local sequential computing mode and in Soma-Workflow</span>
<span class="sd">            modes may be different.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if get_commandline() method is specialized</span>
        <span class="c1"># If yes, we can make use of it to execute the process</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">get_commandline</span> <span class="o">!=</span> <span class="n">Process</span><span class="o">.</span><span class="n">get_commandline</span><span class="p">:</span>
            <span class="n">commandline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_commandline</span><span class="p">()</span>
            <span class="n">soma</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">commandline</span><span class="p">)</span>

        <span class="c1"># Otherwise raise an error</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Either get_commandline() or _run_process() should be &quot;</span>
                <span class="s2">&quot;redefined in process (</span><span class="si">{0}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_before_run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method is called by StudyConfig.run() before calling</span>
<span class="sd">        _run_process(). By default, it does nothing but can be overridden</span>
<span class="sd">        in derived classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_after_run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_process_result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method is called by StudyConfig.run() after calling</span>
<span class="sd">        _run_process(). It is expected to return the final result of the</span>
<span class="sd">        process. By default, it does nothing but can be overridden</span>
<span class="sd">        in derived classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">run_process_result</span>
        

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exec_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method that generate the logging structure from the execution</span>
<span class="sd">        information and class attributes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exec_info: dict (mandatory)</span>
<span class="sd">            the execution information,</span>
<span class="sd">            the dictionary is supposed to contain a runtime attribute.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        log: dict</span>
<span class="sd">            the logging information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set all the execution runtime information in the log</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">exec_info</span><span class="o">.</span><span class="n">runtime</span>

        <span class="c1"># Add the process identifiaction class attribute</span>
        <span class="n">log</span><span class="p">[</span><span class="s2">&quot;process&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

        <span class="c1"># Add the process inputs and outputs</span>
        <span class="n">log</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_info</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">log</span><span class="p">[</span><span class="s2">&quot;outputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_info</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Need to take the representation of undefined input or outputs</span>
        <span class="c1"># traits</span>
        <span class="k">for</span> <span class="n">parameter_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="n">parameter_type</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">[</span><span class="n">parameter_type</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">log</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_rst_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create a rst formatted table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: list of lists of str (mandatory)</span>
<span class="sd">            the table line-cell centent.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rsttable: list of str</span>
<span class="sd">            the rst formatted table containing the input data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Output rst table</span>
        <span class="n">rsttable</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">table_row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cell_row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table_row</span><span class="p">):</span>
                <span class="c1"># &gt; set the parameter name in bold</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">cell_row</span><span class="p">:</span>
                    <span class="n">delimiter_index</span> <span class="o">=</span> <span class="n">cell_row</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                    <span class="n">cell_row</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;**&quot;</span> <span class="o">+</span> <span class="n">cell_row</span><span class="p">[:</span><span class="n">delimiter_index</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;**&quot;</span> <span class="o">+</span>
                                <span class="n">cell_row</span><span class="p">[</span><span class="n">delimiter_index</span><span class="p">:])</span>
                <span class="n">rsttable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_row</span><span class="p">)</span>

        <span class="c1">## Get the size of the largest row in order to</span>
        <span class="c1">## format properly the rst table (do not forget the &#39;+&#39; and &#39;*&#39;)</span>
        <span class="c1">#row_widths = [len(item)</span>
                      <span class="c1">#for item in functools.reduce(operator.add, data)]</span>
        <span class="c1">#width = max(row_widths) + 11</span>

        <span class="c1">## Generate the rst table</span>

        <span class="c1">## &gt; table synthax</span>
        <span class="c1">#rsttable.append(&quot;+&quot; + &quot;-&quot; * width + &quot;+&quot;)</span>
        <span class="c1">## &gt; go through the table lines</span>
        <span class="c1">#for table_row in data:</span>
            <span class="c1">## &gt; go through the cell lines</span>
            <span class="c1">#for index, cell_row in enumerate(table_row):</span>
                <span class="c1">## &gt; set the parameter name in bold</span>
                <span class="c1">#if index == 0 and &quot;:&quot; in cell_row:</span>
                    <span class="c1">#delimiter_index = cell_row.index(&quot;:&quot;)</span>
                    <span class="c1">#cell_row = (&quot;**&quot; + cell_row[:delimiter_index] + &quot;**&quot; +</span>
                                <span class="c1">#cell_row[delimiter_index:])</span>
                <span class="c1">## &gt;  add table rst content</span>
                <span class="c1">#rsttable.append(</span>
                    <span class="c1">#&quot;| | {0}&quot;.format(cell_row) +</span>
                    <span class="c1">#&quot; &quot; * (width - len(cell_row) - 3) +</span>
                    <span class="c1">#&quot;|&quot;)</span>
            <span class="c1">## &gt; close cell</span>
            <span class="c1">#rsttable.append(&quot;+&quot; + &quot;-&quot; * width + &quot;+&quot;)</span>

        <span class="k">return</span> <span class="n">rsttable</span>

    <span class="c1">####################################################################</span>
    <span class="c1"># Public methods</span>
    <span class="c1">####################################################################</span>

<div class="viewcode-block" id="Process.save_log">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.save_log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returncode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to save process execution information in json format.</span>

<span class="sd">        If the class attribute `log_file` is not set, a log.json output</span>
<span class="sd">        file is generated in the process call current working directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        returncode: ProcessResult</span>
<span class="sd">            the process result return code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build the logging information</span>
        <span class="n">exec_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_log</span><span class="p">(</span><span class="n">returncode</span><span class="p">)</span>

        <span class="c1"># Generate an output log file name if necessary</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exec_info</span><span class="p">[</span><span class="s2">&quot;cwd&quot;</span><span class="p">],</span> <span class="s2">&quot;log.json&quot;</span><span class="p">)</span>

        <span class="c1"># Dump the log</span>
        <span class="n">json_struct</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">exec_info</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">check_circular</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># Save the json structure</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">json_struct</span><span class="p">))</span></div>


<div class="viewcode-block" id="Process.help">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.help">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">help</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">returnhelp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to print the full help.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cls: process class (mandatory)</span>
<span class="sd">            a process class</span>
<span class="sd">        returnhelp: bool (optional, default False)</span>
<span class="sd">            if True return the help string message,</span>
<span class="sd">            otherwise display it on the console.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cls_instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cls_instance</span><span class="o">.</span><span class="n">get_help</span><span class="p">(</span><span class="n">returnhelp</span><span class="p">)</span></div>


    <span class="c1">####################################################################</span>
    <span class="c1"># Accessors</span>
    <span class="c1">####################################################################</span>

<div class="viewcode-block" id="Process.get_commandline">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.get_commandline">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_commandline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to generate a commandline representation of the process.</span>

<span class="sd">        If not implemented, it will generate a commandline running python,</span>
<span class="sd">        instantiating the current process, and calling its</span>
<span class="sd">        :meth:`_run_process` method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        commandline: list of strings</span>
<span class="sd">            Arguments are in separate elements of the list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get command line arguments (ie., the process user traits)</span>
        <span class="c1"># Build the python call expression, keeping apart file names.</span>
        <span class="c1"># File names are given separately since they might be modified</span>
        <span class="c1"># externally afterwards, typically to handle temporary files, or</span>
        <span class="c1"># file transfers with Soma-Workflow.</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">ArgPicker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; This small object is only here to have a __repr__() representation which will print sys.argv[n] in a list when writing the commandline code.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;sys.argv[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">num</span>

        <span class="n">reserved_params</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;nodes_activation&quot;</span><span class="p">,</span> <span class="s2">&quot;selection_changed&quot;</span><span class="p">)</span>
        <span class="c1"># pathslist is for files referenced from lists: a list of files will</span>
        <span class="c1"># look like [sys.argv[5], sys.argv[6]...], then the corresponding</span>
        <span class="c1"># path args will be in additional arguments, here stored in pathslist</span>
        <span class="n">pathslist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># argsdict is the dict of non-path arguments, and will be printed</span>
        <span class="c1"># using repr()</span>
        <span class="n">argsdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># pathsdict is the dict of path arguments, and will be printed as a</span>
        <span class="c1"># series of arg_name, path_value, all in separate commandline arguments</span>
        <span class="n">pathsdict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trait_name</span> <span class="ow">in</span> <span class="n">reserved_params</span> \
                    <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_trait_value_defined</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">is_trait_pathname</span><span class="p">(</span><span class="n">trait</span><span class="p">):</span>
                <span class="n">pathsdict</span><span class="p">[</span><span class="n">trait_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">List</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="n">is_trait_pathname</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">inner_traits</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">plist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">pathname</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_trait_value_defined</span><span class="p">(</span><span class="n">pathname</span><span class="p">):</span>
                        <span class="n">plist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ArgPicker</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pathslist</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">pathslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
                <span class="n">argsdict</span><span class="p">[</span><span class="n">trait_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">plist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">argsdict</span><span class="p">[</span><span class="n">trait_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Get the module and class names</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_function&#39;</span><span class="p">):</span>
            <span class="c1"># function with xml decorator</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function</span><span class="o">.</span><span class="vm">__module__</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">call_name</span> <span class="o">=</span> <span class="n">class_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">call_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">()&#39;</span> <span class="o">%</span> <span class="n">class_name</span>

        <span class="c1"># Construct the command line</span>
        <span class="n">python_command</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">commandline</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">python_command</span><span class="p">,</span>
            <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="s2">&quot;import sys; from </span><span class="si">{0}</span><span class="s2"> import </span><span class="si">{1}</span><span class="s2">; kwargs=</span><span class="si">{2}</span><span class="s2">; &quot;</span>
             <span class="s2">&quot;kwargs.update(dict((sys.argv[i * 2 + </span><span class="si">{3}</span><span class="s2">], &quot;</span>
             <span class="s2">&quot;sys.argv[i * 2 + </span><span class="si">{4}</span><span class="s2">]) &quot;</span>
             <span class="s2">&quot;for i in range(int((len(sys.argv) - </span><span class="si">{3}</span><span class="s2">) / 2)))); &quot;</span>
             <span class="s2">&quot;</span><span class="si">{5}</span><span class="s2">(**kwargs)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span>
                                       <span class="nb">repr</span><span class="p">(</span><span class="n">argsdict</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathslist</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                       <span class="nb">len</span><span class="p">(</span><span class="n">pathslist</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                                       <span class="n">call_name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">pathslist</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pathsdict</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="p">[])</span>

        <span class="k">return</span> <span class="n">commandline</span></div>


<div class="viewcode-block" id="Process.params_to_command">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.params_to_command">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">params_to_command</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generates a commandline representation of the process.</span>

<span class="sd">        If not implemented, it will generate a commandline running python,</span>
<span class="sd">        instantiating the current process, and calling its</span>
<span class="sd">        :meth:`_run_process` method.</span>

<span class="sd">        This method is new in Capsul v3 and is a replacement for</span>
<span class="sd">        :meth:`get_commandline`.</span>

<span class="sd">        It can be overwritten by custom Process subclasses. Actually each</span>
<span class="sd">        process should overwrite either :meth:`params_to_command` or</span>
<span class="sd">        :meth:`_run_process`.</span>

<span class="sd">        The returned commandline is a list, which first element is a &quot;method&quot;,</span>
<span class="sd">        and others are the actual commandline with arguments. There are several</span>
<span class="sd">        methods, the process is free to use either of the supported ones,</span>
<span class="sd">        depending on how the execution is implemented.</span>

<span class="sd">        **Methods:**</span>

<span class="sd">        `capsul_job`: Capsul process run in python</span>
<span class="sd">            The command will run the :meth:`_run_process` execution method of</span>
<span class="sd">            the process, after loading input parameters from a JSON dictionary</span>
<span class="sd">            file. The only second element in the commandline list is the</span>
<span class="sd">            process identifier (module/class as in</span>
<span class="sd">            :meth:`~capsul.engine.CapsulEngine.get_process_instance`). The</span>
<span class="sd">            location of the JSON file will be passed to the job execution</span>
<span class="sd">            through an environment variable `SOMAWF_INPUT_PARAMS`::</span>

<span class="sd">                return [&#39;capsul_job&#39;, &#39;morphologist.capsul.morphologist&#39;]</span>

<span class="sd">        `format_string`: free commandline with replacements for parameters</span>
<span class="sd">            Command arguments can be, or contain, format strings in the shape</span>
<span class="sd">            `&#39;%(param)s&#39;`, where `param` is a parameter of the process. This</span>
<span class="sd">            way we can map values correctly, and call a foreign command::</span>

<span class="sd">                return [&#39;format_string&#39;, &#39;ls&#39;, &#39;%(input_dir)s&#39;]</span>

<span class="sd">        `json_job`: free commandline with JSON file for input parameters</span>
<span class="sd">            A bit like `capsul_job` but without the automatic wrapper::</span>

<span class="sd">                return [&#39;json_job&#39;, &#39;python&#39;, &#39;-m&#39;, &#39;my_module&#39;]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        commandline: list of strings</span>
<span class="sd">            Arguments are in separate elements of the list.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">get_commandline</span> <span class="o">!=</span> <span class="n">Process</span><span class="o">.</span><span class="n">get_commandline</span><span class="p">:</span>
            <span class="c1"># get_commandline is overridden the old way: use it.</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;format_string&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_commandline</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;capsul_job&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">]</span></div>


<div class="viewcode-block" id="Process.make_commandline_argument">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.make_commandline_argument">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_commandline_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This helper function may be used to build non-trivial commandline</span>
<span class="sd">        arguments in get_commandline implementations.</span>
<span class="sd">        Basically it concatenates arguments, but it also takes care of keeping</span>
<span class="sd">        track of temporary file objects (if any), and converts non-string</span>
<span class="sd">        arguments to strings (using repr()).</span>

<span class="sd">        Ex:</span>

<span class="sd">        &gt;&gt;&gt; process.make_commandline_argument(&#39;param=&#39;, self.param)</span>

<span class="sd">        will return the same as:</span>

<span class="sd">        &gt;&gt;&gt; &#39;param=&#39; + self.param</span>

<span class="sd">        if self.param is a string (file name) or a temporary path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">built_arg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">):</span> <span class="c1"># tempfile</span>
                <span class="n">built_arg</span> <span class="o">=</span> <span class="n">built_arg</span> <span class="o">+</span> <span class="n">arg</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">built_arg</span> <span class="o">+=</span> <span class="n">arg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">built_arg</span> <span class="o">=</span> <span class="n">built_arg</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">built_arg</span></div>


<div class="viewcode-block" id="Process.run_from_commandline">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.run_from_commandline">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_from_commandline</span><span class="p">(</span><span class="n">process_definition</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Run a process from a commandline call. The process name (with module)</span>
<span class="sd">        are given in argument, input parameters should be passed through a JSON</span>
<span class="sd">        file which location is in the ``SOMAWF_INPUT_PARAMS`` environment</span>
<span class="sd">        variable.</span>

<span class="sd">        If the process has outputs, the ``SOMAWF_OUTUT_PARAMS`` environment</span>
<span class="sd">        variable should contain the location of an output file which will be</span>
<span class="sd">        written with a dict containing output parameters values.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">capsul.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">capsul_engine</span>

        <span class="n">ce</span> <span class="o">=</span> <span class="n">capsul_engine</span><span class="p">()</span>

        <span class="n">param_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SOMAWF_INPUT_PARAMS&#39;</span><span class="p">)</span>

        <span class="c1"># fix expandvars problem when the env var SOMAWF_OUTPUT_PARAMS is</span>
        <span class="c1"># defined from a script and passed into a container (like bv set</span>
        <span class="c1"># through soma-workflow config using &quot;$SOMAWF_OUTPUT_PARAMS&quot;): when the</span>
        <span class="c1"># &quot;source&quot; variable is not set, os.expandvars() leaves the value</span>
        <span class="c1"># &quot;$SOMAWF_OUTPUT_PARAMS&quot; untouched, but here we would expect an empty</span>
        <span class="c1"># variable</span>
        <span class="k">if</span> <span class="n">param_file</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;$SOMAWF_INPUT_PARAMS&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="si">{SOMAWF_INPUT_PARAMS}</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">param_file</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_file</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: no input parameters, the env variable &#39;</span>
                  <span class="s1">&#39;SOMAWF_INPUT_PARAMS is not set.&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">params_conf</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">param_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">params_conf</span> <span class="o">=</span> <span class="n">json_utils</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="n">configuration</span> <span class="o">=</span> <span class="n">params_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;configuration_dict&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">configuration</span><span class="p">:</span>
            <span class="c1"># activation will be re-done during run() but some global configs</span>
            <span class="c1"># (nipype SPM/Matlab settings) need to be done before any process</span>
            <span class="c1"># is instantiated, so we must do it earlier, right now.</span>

            <span class="c1"># clear activations for now.</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">capsul</span><span class="w"> </span><span class="kn">import</span> <span class="n">engine</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">activated_modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">activate_configuration</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">params_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1">## filter out undefined values -- maybe this is not OK in all cases:</span>
        <span class="c1">## we may want to manually reset a parameter, but in normal cases,</span>
        <span class="c1">## Undefined values are just not set, which means that the values are</span>
        <span class="c1">## left to defaults depending on the global config: nipype works like</span>
        <span class="c1">## this for matlab parameters.</span>
        <span class="c1">#params = dict([(k, v) for k, v in params.items()</span>
                       <span class="c1">#if v is not Undefined])</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">get_process_instance</span><span class="p">(</span><span class="n">process_definition</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">process</span><span class="o">.</span><span class="n">import_from_dict</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error in setting parameters of process </span><span class="si">%s</span><span class="s1">, with dict:&#39;</span>
                  <span class="o">%</span> <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="c1"># actually run the process</span>
        <span class="n">ce</span><span class="o">.</span><span class="n">study_config</span><span class="o">.</span><span class="n">use_soma_workflow</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_work_dir</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">temp_work_dir</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">study_config</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">process</span><span class="p">,</span>
                                         <span class="n">configuration_dict</span><span class="o">=</span><span class="n">configuration</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
        <span class="c1"># collect output parameters</span>
        <span class="n">out_param_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SOMAWF_OUTPUT_PARAMS&#39;</span><span class="p">)</span>

        <span class="c1"># fix expandvars problem when the env var SOMAWF_OUTPUT_PARAMS is</span>
        <span class="c1"># defined from a script and passed into a container (like bv set</span>
        <span class="c1"># through soma-workflow config using &quot;$SOMAWF_OUTPUT_PARAMS&quot;): when the</span>
        <span class="c1"># &quot;source&quot; variable is not set, os.expandvars() leaves the value</span>
        <span class="c1"># &quot;$SOMAWF_OUTPUT_PARAMS&quot; untouched, but here we would expect an empty</span>
        <span class="c1"># variable</span>
        <span class="k">if</span> <span class="n">out_param_file</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;$SOMAWF_OUTPUT_PARAMS&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;$</span><span class="si">{SOMAWF_OUTPUT_PARAMS}</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">out_param_file</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">output_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">out_param_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">reserved_params</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;nodes_activation&quot;</span><span class="p">,</span> <span class="s2">&quot;selection_changed&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">reserved_params</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="p">(</span><span class="n">File</span><span class="p">,</span> <span class="n">Directory</span><span class="p">))</span> \
                        <span class="ow">and</span> <span class="n">trait</span><span class="o">.</span><span class="n">input_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="n">List</span><span class="p">)</span> \
                        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">inner_traits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span>
                                       <span class="p">(</span><span class="n">File</span><span class="p">,</span> <span class="n">Directory</span><span class="p">))</span> \
                        <span class="ow">and</span> <span class="n">trait</span><span class="o">.</span><span class="n">inner_traits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trait_type</span><span class="o">.</span><span class="n">input_filename</span> \
                            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> \
                        <span class="ow">and</span> <span class="n">trait</span><span class="o">.</span><span class="n">input_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">output_params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
            <span class="n">output_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_param_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_utils</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">output_params</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>

        <span class="c1"># if there was no exception, we assume the process has succeeded.</span>
        <span class="c1"># sys.exit(0)</span>
        <span class="c1"># no error, do a dirty exit, but avoid cleanup crashes after the</span>
        <span class="c1"># process has succeeded...</span>
        <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="Process.get_log">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.get_log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Load the logging file.</span>

<span class="sd">        .. note:</span>

<span class="sd">            If no log file found, return None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        log: dict</span>
<span class="sd">            the content of the log file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Process.get_input_spec">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.get_input_spec">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to access the process input specifications.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        outputs: str</span>
<span class="sd">            a string representation of all the input trait specifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">INPUT SPECIFICATIONS</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="c1"># self.traits(output=False) skips params with no output property</span>
        <span class="k">for</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">trait_name</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="Process.get_output_spec">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.get_output_spec">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_output_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to access the process output specifications.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        outputs: str</span>
<span class="sd">            a string representation of all the output trait specifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">OUTPUT SPECIFICATIONS</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traits</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="n">trait_name</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="Process.get_inputs">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.get_inputs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to access the process inputs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        outputs: dict</span>
<span class="sd">            a dictionary with all the input trait names and values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">trait_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="Process.get_outputs">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.get_outputs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to access the process outputs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        outputs: dict</span>
<span class="sd">            a dictionary with all the output trait names and values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traits</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
            <span class="n">output</span><span class="p">[</span><span class="n">trait_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="Process.get_help">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.get_help">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returnhelp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generate description of a process parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        returnhelp: bool (optional, default False)</span>
<span class="sd">            if True return the help string message formatted in rst,</span>
<span class="sd">            otherwise display the raw help string message on the console.</span>
<span class="sd">        use_labels: bool</span>
<span class="sd">            if True, input and output sections will get a RestructuredText</span>
<span class="sd">            label to avoid ambiguities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the help content variable</span>
        <span class="n">doctring</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="c1"># Update the documentation with a description of the pipeline</span>
        <span class="c1"># when the xml to pipeline wrapper has been used</span>
        <span class="k">if</span> <span class="n">returnhelp</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_pipeline_desc&quot;</span><span class="p">):</span>
            <span class="n">str_desc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;    </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipeline_desc</span><span class="p">])</span>
            <span class="n">doctring</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="s2">&quot;.. hidden-code-block:: python&quot;</span><span class="p">,</span>
                <span class="s2">&quot;    :starthidden: True&quot;</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">str_desc</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span>
            <span class="p">]</span>

        <span class="c1"># Get the process docstring</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
            <span class="n">doctring</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="c1"># Update the documentation with a reference on the source function</span>
        <span class="c1"># when the function to process wrapper has been used</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_func_name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_func_module&quot;</span><span class="p">):</span>
            <span class="n">doctring</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="s2">&quot;This process has been wrapped from </span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_func_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_name</span><span class="p">),</span>
                <span class="s2">&quot;&quot;</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">returnhelp</span><span class="p">:</span>
                <span class="n">doctring</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="s2">&quot;.. currentmodule:: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func_module</span><span class="p">),</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;.. autosummary::&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;    :toctree: ./&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;    </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func_name</span><span class="p">),</span>
                    <span class="s2">&quot;&quot;</span>
                <span class="p">]</span>

        <span class="c1"># Append the input and output traits help</span>
        <span class="k">if</span> <span class="n">use_labels</span><span class="p">:</span>
            <span class="n">in_label</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.. _</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">_inputs:</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
            <span class="n">out_label</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.. _</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">_outputs:</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">in_label</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">out_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">full_help</span> <span class="o">=</span> <span class="p">(</span><span class="n">doctring</span> <span class="o">+</span> <span class="n">in_label</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input_help</span><span class="p">(</span><span class="n">returnhelp</span><span class="p">)</span>
                     <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">out_label</span>
                     <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_help</span><span class="p">(</span><span class="n">returnhelp</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">])</span>
        <span class="n">full_help</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">full_help</span><span class="p">)</span>

        <span class="c1"># Return the full process help</span>
        <span class="k">if</span> <span class="n">returnhelp</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">full_help</span>
        <span class="c1"># Print the full process help</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">full_help</span><span class="p">)</span></div>


<div class="viewcode-block" id="Process.get_input_help">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.get_input_help">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rst_formating</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generate description for process input parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rst_formating: bool (optional, default False)</span>
<span class="sd">            if True generate a rst table with the input descriptions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        helpstr: str</span>
<span class="sd">            the class input traits help</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate an input section</span>
        <span class="n">helpstr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;~&quot;</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="c1"># Markup to separate mandatory inputs</span>
        <span class="n">manhelpstr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;[Mandatory]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="c1"># Get all the mandatory input traits</span>
        <span class="n">mandatory_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">())</span>
                           <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">optional</span><span class="p">]</span>
        <span class="c1">#mandatory_items.update(self.traits(output=None, optional=False))</span>

        <span class="c1"># If we have mandatory inputs, get the corresponding string</span>
        <span class="c1"># descriptions</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">mandatory_items</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">mandatory_items</span><span class="p">:</span>
                <span class="n">trait_desc</span> <span class="o">=</span> <span class="n">get_trait_desc</span><span class="p">(</span><span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span><span class="p">,</span>
                                            <span class="n">use_wrap</span><span class="o">=</span><span class="ow">not</span> <span class="n">rst_formating</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trait_desc</span><span class="p">)</span>

        <span class="c1"># If we want to format the output nicely (rst)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">rst_formating</span><span class="p">:</span>
                <span class="n">manhelpstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rst_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># Otherwise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">manhelpstr</span> <span class="o">+=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># Markup to separate optional inputs</span>
        <span class="n">opthelpstr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;[Optional]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="c1"># Get all optional input traits</span>
        <span class="n">optional_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">())</span>
                          <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">optional</span><span class="p">]</span>
        <span class="c1">#optional_items = self.traits(output=False, optional=True)</span>
        <span class="c1">#optional_items.update(self.traits(output=None, optional=True))</span>

        <span class="c1"># If we have optional inputs, get the corresponding string</span>
        <span class="c1"># descriptions</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">optional_items</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">optional_items</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">get_trait_desc</span><span class="p">(</span><span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span><span class="p">,</span>
                                   <span class="n">use_wrap</span><span class="o">=</span><span class="ow">not</span> <span class="n">rst_formating</span><span class="p">))</span>

        <span class="c1"># If we want to format the output nicely (rst)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">rst_formating</span><span class="p">:</span>
                <span class="n">opthelpstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rst_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># Otherwise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opthelpstr</span> <span class="o">+=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># Add the mandatory and optional input string description if necessary</span>
        <span class="k">if</span> <span class="n">mandatory_items</span><span class="p">:</span>
            <span class="n">helpstr</span> <span class="o">+=</span> <span class="n">manhelpstr</span>
        <span class="k">if</span> <span class="n">optional_items</span><span class="p">:</span>
            <span class="n">helpstr</span> <span class="o">+=</span> <span class="n">opthelpstr</span>

        <span class="k">return</span> <span class="n">helpstr</span></div>


<div class="viewcode-block" id="Process.get_output_help">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.get_output_help">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_output_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rst_formating</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generate description for process output parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rst_formating: bool (optional, default False)</span>
<span class="sd">            if True generate a rst table with the input descriptions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        helpstr: str</span>
<span class="sd">            the trait output help descriptions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate an output section</span>
        <span class="n">helpstr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Outputs&quot;</span><span class="p">,</span> <span class="s2">&quot;~&quot;</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="c1"># Get all the process output traits, keep their order</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">trait</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">())</span>
                 <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span><span class="p">]</span>

        <span class="c1"># If we have no output trait, return no string description</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="c1"># If we have some outputs, get the corresponding string</span>
        <span class="c1"># descriptions</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">get_trait_desc</span><span class="p">(</span><span class="n">trait_name</span><span class="p">,</span> <span class="n">trait</span><span class="p">,</span> <span class="n">use_wrap</span><span class="o">=</span><span class="ow">not</span> <span class="n">rst_formating</span><span class="p">))</span>

        <span class="c1"># If we want to format the output nicely (rst)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">rst_formating</span><span class="p">:</span>
                <span class="n">helpstr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rst_table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># Otherwise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">helpstr</span> <span class="o">+=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">helpstr</span></div>


<div class="viewcode-block" id="Process.set_parameter">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.set_parameter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">protected</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to set a process instance trait value.</span>

<span class="sd">        For File and Directory traits the None value is replaced by the</span>
<span class="sd">        special Undefined trait value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str (mandatory)</span>
<span class="sd">            the trait name we want to modify</span>
<span class="sd">        value: object (mandatory)</span>
<span class="sd">            the trait value we want to set</span>
<span class="sd">        protected: None or bool (tristate)</span>
<span class="sd">            if True or False, force the &quot;protected&quot; status of the plug. If None,</span>
<span class="sd">            keep it as is.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The None trait value is Undefined, do the replacement</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">if</span> <span class="n">protected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protect_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">protected</span><span class="p">)</span>
        <span class="c1"># Set the new trait value</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="Process.get_parameter">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.get_parameter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to access the value of a process instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str (mandatory)</span>
<span class="sd">            the trait name we want to modify</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        value: object</span>
<span class="sd">            the trait value we want to access</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="Process.get_study_config">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.get_study_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_study_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Get (or create) the StudyConfig this process belongs to</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Import cannot be done on module due to circular dependencies</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">capsul.study_config.study_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_study_config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_study_config</span><span class="p">(</span><span class="n">default_study_config</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_config</span></div>


<div class="viewcode-block" id="Process.set_study_config">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.set_study_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_study_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">study_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Set a StudyConfig for the process.</span>
<span class="sd">        Note that it can only be done once: once a non-null StudyConfig has</span>
<span class="sd">        been assigned to the process, it should not change.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">study_config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A StudyConfig had already been set in the &quot;</span>
                             <span class="s2">&quot;process </span><span class="si">%s</span><span class="s2">. It cannot be changed afterwards.&quot;</span>
                             <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">study_config</span> <span class="o">=</span> <span class="n">study_config</span></div>


<div class="viewcode-block" id="Process.get_missing_mandatory_parameters">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.get_missing_mandatory_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_missing_mandatory_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Returns a list of parameters which are not optional, and which</span>
<span class="sd">        value is Undefined or None, or an empty string for a File or</span>
<span class="sd">        Directory parameter.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">check_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">optional</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="s1">&#39;inner_traits&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">inner_traits</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">inner_traits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_trait</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">inner_traits</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">item</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">trait_type</span><span class="p">,</span> <span class="p">(</span><span class="n">File</span><span class="p">,</span> <span class="n">Directory</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="n">trait</span><span class="o">.</span><span class="n">input_filename</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="c1"># filename is an output</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Undefined</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Undefined</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">trait</span><span class="o">.</span><span class="n">optional</span> <span class="ow">and</span> <span class="n">trait</span><span class="o">.</span><span class="n">xor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                    <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">trait</span><span class="o">.</span><span class="n">optional</span><span class="p">:</span>
                <span class="n">xors</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trait</span><span class="o">.</span><span class="n">xor</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">traits</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">optional</span><span class="p">]</span>
                <span class="c1"># Mutually exclusive means xors must have only one element?</span>
                <span class="c1"># value_xor = self.get_parameter(xors[0])</span>
                <span class="c1"># value = self.get_parameter(name)</span>
                <span class="c1"># if not check_trait(self.traits()[xors[0]], value_xor) and not check_trait(trait, value):</span>
                <span class="c1">#     missing.append(name)</span>
                <span class="n">result_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">check_trait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traits</span><span class="p">()[</span><span class="n">i</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xors</span><span class="p">]</span>
                <span class="n">result_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">check_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">result_check</span><span class="p">):</span>
                    <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">missing</span></div>


<div class="viewcode-block" id="Process.requirements">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.requirements">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Requirements needed to run the process. It is a dictionary which keys are config/settings modules and values are requests for them.</span>

<span class="sd">        The default implementation returns an empty dict (no requirements), and</span>
<span class="sd">        should be overloaded by processes which actually have requirements.</span>

<span class="sd">        Ex::</span>

<span class="sd">            {&#39;spm&#39;: &#39;version &gt;= &quot;12&quot; and standalone == &quot;True&quot;&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="Process.check_requirements">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.Process.check_requirements">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="n">message_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks the process requirements against configuration settings values</span>
<span class="sd">        in the attached CapsulEngine. This makes use of the</span>
<span class="sd">        :meth:`requirements` method and checks that there is one matching</span>
<span class="sd">        config value for each required module.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        environment: str</span>
<span class="sd">            config environment id. Normally corresponds to the computing</span>
<span class="sd">            resource name, and defaults to &quot;global&quot;.</span>
<span class="sd">        message_list: list</span>
<span class="sd">            if not None, this list will be updated with messages for</span>
<span class="sd">            unsatisfied requirements, in order to present the user with an</span>
<span class="sd">            understandable error.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        config: dict, list, or None</span>
<span class="sd">            if None is returned, requirements are not met: the process cannot</span>
<span class="sd">            run. If a dict is returned, it corresponds to the matching config</span>
<span class="sd">            values. When no requirements are needed, an empty dict is returned.</span>
<span class="sd">            A pipeline, if its requirements are met will return a list of</span>
<span class="sd">            configuration values, because different nodes may require different</span>
<span class="sd">            config values.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_study_config</span><span class="p">()</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">settings</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirements</span><span class="p">()</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">select_configurations</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">uses</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
                                                <span class="n">check_invalid_mods</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">new_req</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capsul_engine&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uses&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">new_req</span><span class="p">:</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">module_name</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">message_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">message_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;requirement: </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> is not met in </span><span class="si">%s</span><span class="s1">&#39;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">new_req</span><span class="p">[</span><span class="n">module_name</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">module_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="c1"># if no message is expected, then we can return immediately</span>
                <span class="c1"># without checking further requirements. Otherwise we</span>
                <span class="c1"># continue to get a full list of unsatisfied requirements.</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;requirement:&#39;</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">new_req</span><span class="p">[</span><span class="n">module_name</span><span class="p">],</span>
                      <span class="s1">&#39;not met in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;config:&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">select_configurations</span><span class="p">(</span><span class="n">environment</span><span class="p">),</span>
                      <span class="n">end</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="FileCopyProcess">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.FileCopyProcess">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FileCopyProcess</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A specific process that copies all the input files.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    copied_inputs : dict</span>
<span class="sd">        the list of copied file parameters {param: dst_value}</span>
<span class="sd">    copied_files: dict</span>
<span class="sd">        copied files {param: [dst_value1, ...]}</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    __call__</span>
<span class="sd">    _update_input_traits</span>
<span class="sd">    _get_process_arguments</span>
<span class="sd">    _copy_input_files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activate_copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inputs_to_copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">inputs_to_clean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">inputs_to_symlink</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_temp_output_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize the FileCopyProcess class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        activate_copy: bool (default True)</span>
<span class="sd">            if False this class is transparent and behaves as a Process class.</span>
<span class="sd">        inputs_to_copy: list of str (optional, default None)</span>
<span class="sd">            the list of inputs to copy.</span>
<span class="sd">            If None, all the input files are copied.</span>
<span class="sd">        inputs_to_clean: list of str (optional, default None)</span>
<span class="sd">            some copied inputs that can be deleted at the end of the</span>
<span class="sd">            processing. If None, all copied files will be cleaned.</span>
<span class="sd">        destination: str (optional default None)</span>
<span class="sd">            where the files are copied.</span>
<span class="sd">            If None, the output directory will be used, unless</span>
<span class="sd">            use_temp_output_dir is set.</span>
<span class="sd">        inputs_to_symlink: list of str (optional, default None)</span>
<span class="sd">            as inputs_to_copy, but for files which should be symlinked</span>
<span class="sd">        use_temp_output_dir: bool</span>
<span class="sd">            if True, the output_directory parameter is set to a temp one during</span>
<span class="sd">            execution, then outputs are copied / moved / hardlinked to the</span>
<span class="sd">            final location. This is useful when several parallel jobs are</span>
<span class="sd">            working in the same directory and may write the same intermediate</span>
<span class="sd">            files (SPM does this a lot).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Inheritance</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FileCopyProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Class parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_copy</span> <span class="o">=</span> <span class="n">activate_copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">destination</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_copy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs_to_clean</span> <span class="o">=</span> <span class="n">inputs_to_clean</span>
            <span class="k">if</span> <span class="n">inputs_to_symlink</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs_to_symlink</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs_to_symlink</span> <span class="o">=</span> <span class="n">inputs_to_symlink</span>
            <span class="k">if</span> <span class="n">inputs_to_copy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs_to_copy</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                       <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs_to_symlink</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs_to_copy</span> <span class="o">=</span> <span class="n">inputs_to_copy</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs_to_symlink</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs_to_symlink</span>
                                          <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs_to_copy</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copied_inputs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copied_files</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_temp_output_dir</span> <span class="o">=</span> <span class="n">use_temp_output_dir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_before_run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to copy files before executing the process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FileCopyProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_before_run_process</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_directory</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;output_directory&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output_directory</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="n">output_directory</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_temp_output_dir</span><span class="p">:</span>
                <span class="n">workspace</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">output_directory</span><span class="p">,</span>
                                             <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">destdir</span> <span class="o">=</span> <span class="n">workspace</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">destdir</span> <span class="o">=</span> <span class="n">output_directory</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">destdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">destination</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">destdir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;FileCopyProcess cannot be used without a &#39;</span>
                             <span class="s1">&#39;destination directory&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_destination</span> <span class="o">=</span> <span class="n">destdir</span>
        <span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">destination</span>
        <span class="k">if</span> <span class="n">output_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_directory</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;output_directory&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_directory</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_former_output_directory</span> <span class="o">=</span> <span class="n">output_directory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">destdir</span>

        <span class="c1"># The copy option is activated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_copy</span><span class="p">:</span>

            <span class="c1"># Copy the desired items</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_input_traits</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_recorded_params</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Set the process inputs</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copied_inputs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_recorded_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_after_run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_process_result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to clean-up temporary workspace after process</span>
<span class="sd">        execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_process_result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FileCopyProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_after_run_process</span><span class="p">(</span>
            <span class="n">run_process_result</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_temp_output_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_move_outputs</span><span class="p">()</span>
        <span class="c1"># The copy option is activated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activate_copy</span><span class="p">:</span>
            <span class="c1"># Clean the workspace</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clean_workspace</span><span class="p">()</span>

        <span class="c1"># restore initial values, keeping outputs</span>
        <span class="c1"># The situation here is that:</span>
        <span class="c1"># * output_directory should drive &quot;final&quot; output values</span>
        <span class="c1"># * we may have been using a temporary output directory, thus output</span>
        <span class="c1">#   values are already set to this temp dir, not the final one.</span>
        <span class="c1">#   (at least when use_temp_output_dir is set).</span>
        <span class="c1">#   -&gt; _move_outputs() already changes these output values</span>
        <span class="c1"># * when we reset inputs, outputs are reset to values pointing to</span>
        <span class="c1">#   the input directory (via nipype callbacks).</span>
        <span class="c1"># So we must:</span>
        <span class="c1"># 1. record output values</span>
        <span class="c1"># 2. set again inputs to their initial values (pointing to the input</span>
        <span class="c1">#    directories). Outputs will be reset accordingly to input dirs.</span>
        <span class="c1"># 3. force output values using the recorded ones.</span>

        <span class="c1"># 1. record output values</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="n">outputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># 2. set again inputs to their initial values</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_recorded_params&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recorded_params</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># 3. force output values using the recorded ones</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_recorded_params&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recorded_params</span>

        <span class="k">return</span> <span class="n">run_process_result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_workspace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Removed some copied inputs that can be deleted at the end of the</span>
<span class="sd">        processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs_to_clean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs_to_clean</span>
        <span class="k">if</span> <span class="n">inputs_to_clean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># clean all copied inputs</span>
            <span class="n">inputs_to_clean</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copied_files</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">to_rm_name</span> <span class="ow">in</span> <span class="n">inputs_to_clean</span><span class="p">:</span>
            <span class="n">rm_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copied_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">to_rm_name</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">rm_files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rm_files</span><span class="p">(</span><span class="n">rm_files</span><span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">copied_files</span><span class="p">[</span><span class="n">to_rm_name</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">copied_inputs</span><span class="p">[</span><span class="n">to_rm_name</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_move_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tmp_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_destination</span>
        <span class="n">dst_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_former_output_directory</span>
        <span class="n">output_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">moved_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_files</span><span class="p">(</span><span class="n">tmp_output</span><span class="p">,</span> <span class="n">dst_output</span><span class="p">,</span>
                                             <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">),</span>
                                             <span class="n">moved_dict</span><span class="o">=</span><span class="n">moved_dict</span><span class="p">)</span>
                <span class="n">output_values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_output</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_destination</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_former_output_directory</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;output_directory&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_former_output_directory</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_former_output_directory</span>
        <span class="k">return</span> <span class="n">output_values</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_move_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_directory</span><span class="p">,</span> <span class="n">dst_directory</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">moved_dict</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_move_files</span><span class="p">(</span><span class="n">src_directory</span><span class="p">,</span> <span class="n">dst_directory</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span>
                                          <span class="n">moved_dict</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">new_value</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_files</span><span class="p">(</span>
                    <span class="n">src_directory</span><span class="p">,</span> <span class="n">dst_directory</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">moved_dict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">moved_dict</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">moved_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="n">src_directory</span> \
                    <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">matfnames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span><span class="p">))</span>
                <span class="n">todo</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">matfnames</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">value</span><span class="p">]</span>
                <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_directory</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning: file or directory </span><span class="si">%s</span><span class="s1"> exists&#39;</span> <span class="o">%</span> <span class="n">dst</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># print(&#39;moving:&#39;, value, &#39;to:&#39;, dst)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">moved_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">todo</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_move_files</span><span class="p">(</span><span class="n">src_directory</span><span class="p">,</span> <span class="n">dst_directory</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span>
                                     <span class="n">moved_dict</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">dst</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_rm_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">python_object</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Remove a set of copied files from the filesystem.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        python_object: object</span>
<span class="sd">            a generic python object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Deal with dictionary</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">python_object</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">python_object</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rm_files</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="c1"># Deal with tuple and list</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">python_object</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">python_object</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rm_files</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="c1"># Otherwise start the deletion if the object is a file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">python_object</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">python_object</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">python_object</span><span class="p">)</span>

<div class="viewcode-block" id="FileCopyProcess._update_input_traits">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.FileCopyProcess._update_input_traits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_input_traits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Update the process input traits: input files are copied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the new trait values</span>
        <span class="n">input_parameters</span><span class="p">,</span> <span class="n">input_symlinks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_process_arguments</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copied_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copied_inputs</span> \
            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_input_files</span><span class="p">(</span><span class="n">input_parameters</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">copied_files</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copied_inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy_input_files</span><span class="p">(</span><span class="n">input_symlinks</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">copied_files</span><span class="p">,</span>
                                   <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">))</span></div>


<div class="viewcode-block" id="FileCopyProcess._copy_input_files">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.FileCopyProcess._copy_input_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_copy_input_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">python_object</span><span class="p">,</span> <span class="n">use_symlink</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">files_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Recursive method that copy the input process files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        python_object: object</span>
<span class="sd">            a generic python object.</span>
<span class="sd">        use_symlink: bool</span>
<span class="sd">            if True, symbolic links will be make instead of full copies, on</span>
<span class="sd">            systems which support symlinks. Much faster and less disk consuming</span>
<span class="sd">            than full copies, but might have side effects in programs which</span>
<span class="sd">            detect and handle symlinks in a different way.</span>
<span class="sd">        files_list: list or dict</span>
<span class="sd">            if provided, this *output* parameter will be updated with the list</span>
<span class="sd">            of files actually created.</span>
<span class="sd">        copy: bool</span>
<span class="sd">            if False, files are not actually copied/symlinked but filenames are</span>
<span class="sd">            generated</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        out: object</span>
<span class="sd">            the copied-file input object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># on windows, no symlinks (in python2 at least).</span>
            <span class="n">use_symlink</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Deal with dictionary</span>
        <span class="c1"># Create an output dict that will contain the copied file locations</span>
        <span class="c1"># and the other values</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">python_object</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">python_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files_list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">sub_files_list</span> <span class="o">=</span> <span class="n">files_list</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sub_files_list</span> <span class="o">=</span> <span class="n">files_list</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_input_files</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">use_symlink</span><span class="p">,</span>
                                                      <span class="n">sub_files_list</span><span class="p">,</span>
                                                      <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>

        <span class="c1"># Deal with tuple and list</span>
        <span class="c1"># Create an output list or tuple that will contain the copied file</span>
        <span class="c1"># locations and the other values</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">python_object</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">python_object</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_copy_input_files</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">use_symlink</span><span class="p">,</span>
                                                      <span class="n">files_list</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">python_object</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="c1"># Otherwise start the copy (with metadata cp -p) if the object is</span>
        <span class="c1"># a file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">python_object</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">python_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undefined</span> <span class="ow">and</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">python_object</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">python_object</span><span class="p">)):</span>
                <span class="n">destdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_destination</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destdir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destdir</span><span class="p">)</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">python_object</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="n">python_object</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">out</span>  <span class="c1"># input=output, nothing to do</span>
                <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">use_symlink</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">python_object</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">python_object</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">files_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">files_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

                    <span class="c1"># Copy associated .mat/.json/.minf files</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">matfnames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">python_object</span><span class="p">),</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">matfname</span> <span class="ow">in</span> <span class="n">matfnames</span><span class="p">:</span>
                        <span class="n">extrafname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">matfname</span><span class="p">)</span>
                        <span class="n">extraout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="n">extrafname</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">extraout</span> <span class="o">!=</span> <span class="n">out</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">extraout</span><span class="p">)</span> \
                                    <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">extraout</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">extraout</span><span class="p">):</span>
                                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">extraout</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">extraout</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">use_symlink</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">matfname</span><span class="p">,</span> <span class="n">extraout</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">matfname</span><span class="p">,</span> <span class="n">extraout</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">files_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">files_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extraout</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="FileCopyProcess._get_process_arguments">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.FileCopyProcess._get_process_arguments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_process_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Get the process arguments.</span>

<span class="sd">        The user process traits are accessed through the user_traits()</span>
<span class="sd">        method that returns a sorted dictionary.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        input_parameters: dict</span>
<span class="sd">            the process input parameters that should be copied.</span>
<span class="sd">        input_symlinks: dict</span>
<span class="sd">            the process input parameters that should be symlinked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store for input parameters</span>
        <span class="n">input_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">input_symlinks</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Go through all the user traits</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">trait</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Check if the target parameter is in the check list</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs_to_copy</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs_to_symlink</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">or</span> <span class="n">s</span><span class="p">:</span>
                <span class="c1"># Get the trait value</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># Skip undefined trait attributes and outputs</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="c1"># Store the input parameter</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                        <span class="n">input_parameters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">input_symlinks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">input_parameters</span><span class="p">,</span> <span class="n">input_symlinks</span></div>
</div>



<div class="viewcode-block" id="NipypeProcess">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.NipypeProcess">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NipypeProcess</span><span class="p">(</span><span class="n">FileCopyProcess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Base class used to wrap nipype interfaces.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">init_with_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="n">cls</span>
            <span class="n">init_att</span> <span class="o">=</span> <span class="s1">&#39;__</span><span class="si">%s</span><span class="s1">_np_init_done__&#39;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_att</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_att</span><span class="p">):</span>
                <span class="c1"># may be called twice, from within __new__ or from python</span>
                <span class="c1"># internals</span>
                <span class="k">return</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_att</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="ow">is</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="fm">__init__</span> <span class="ow">and</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NipypeProcess</span><span class="p">:</span>
            <span class="c1"># we must setup a conditional __init__ for each specialized class</span>
            <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="n">init_with_skip</span>
            <span class="n">init_with_skip</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="bp">cls</span>

        <span class="c1"># determine if we were called from within nipype_factory()</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_stack</span><span class="p">()</span>
        <span class="c1"># stack[-1] should be here</span>
        <span class="c1"># stack[-2] may be nipype_factory</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">s2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nipype_factory&#39;</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">NipypeProcess</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                                                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s1">&#39;__</span><span class="si">%s</span><span class="s1">_np_init_done__&#39;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">instance</span>
        <span class="n">nipype_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;_nipype_class_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">nkwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="n">arg0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">nipype_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arg0</span> <span class="o">=</span> <span class="n">nipype_class</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;nipype_class&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">arg0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;nipype_class&#39;</span><span class="p">]()</span>
                <span class="n">nkwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;nipype_class&#39;</span><span class="p">}</span>
            <span class="k">elif</span> <span class="s1">&#39;nipype_instance&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">nipype.interfaces.base</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nipype</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">BaseInterface</span><span class="p">):</span>
                    <span class="n">arg0</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">nargs</span> <span class="o">=</span> <span class="n">nargs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nipype</span><span class="o">.</span><span class="n">interfaces</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">BaseInterface</span><span class="p">):</span>
                    <span class="n">arg0</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]()</span>
                    <span class="n">nargs</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">arg0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.nipype_process</span><span class="w"> </span><span class="kn">import</span> <span class="n">nipype_factory</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">nipype_factory</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">base_class</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">nargs</span><span class="p">,</span> <span class="o">**</span><span class="n">nkwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">cls</span> <span class="o">!=</span> <span class="n">NipypeProcess</span><span class="p">:</span>
                <span class="c1"># override direct nipype reference</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> \
                    <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">name</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">__postinit__</span><span class="p">(</span><span class="o">*</span><span class="n">nargs</span><span class="p">,</span> <span class="o">**</span><span class="n">nkwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">NipypeProcess</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s1">&#39;__</span><span class="si">%s</span><span class="s1">_np_init_done__&#39;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nipype_instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_temp_output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize the NipypeProcess class.</span>

<span class="sd">        NipypeProcess instance gets automatically an additional user trait</span>
<span class="sd">        &#39;output_directory&#39;.</span>

<span class="sd">        This class also fix some lacks of the nipype version &#39;0.10.0&#39;.</span>

<span class="sd">        NipypeProcess is normally not instantiated directly, but through the</span>
<span class="sd">        CapsulEngine factory, using a nipype interface name::</span>

<span class="sd">            ce = capsul_engine()</span>
<span class="sd">            npproc = ce.get_process_instance(&#39;nipype.interfaces.spm.Smooth&#39;)</span>

<span class="sd">        However, it is now still possible to instantiate it directly, using a</span>
<span class="sd">        nipype interface class or instance::</span>

<span class="sd">            npproc = NipypeProcess(nipype.interfaces.spm.Smooth)</span>

<span class="sd">        NipypeProcess may be subclassed for specialized interfaces. In such a</span>
<span class="sd">        case, the subclass may provide:</span>

<span class="sd">        * (optionally) a class attribute `_nipype_class_type` to specify the</span>
<span class="sd">        nipype interface class. If present the nipype interface class or</span>
<span class="sd">        instance will not be specified in the constructor call.</span>
<span class="sd">        * (optionally) a :meth:`__postinit__` method which will be called in</span>
<span class="sd">        addition to the constructor, but later once the instance is correctly</span>
<span class="sd">        setup. This `__postinit__` method allows to customize the new class</span>
<span class="sd">        instance.</span>
<span class="sd">        * (optionally) a class attribute `_nipype_trait_mapping`: a dict</span>
<span class="sd">        specifying a translation table between nipype traits names and the</span>
<span class="sd">        names they will get in the Process instance. By default, inputs get the</span>
<span class="sd">        same name as in their nipype interface, and outputs are prefixed with</span>
<span class="sd">        an underscore (&#39;_&#39;) to avoid names collisions when a trait exists both</span>
<span class="sd">        in inputs and outputs in nipype. A special trait name</span>
<span class="sd">        `_spm_script_file` is also used in SPM interfaces to write the matlab</span>
<span class="sd">        script. It can also be translated to a different name in this dict.</span>

<span class="sd">        Subclasses should preferably *not* define an __init__ method, because</span>
<span class="sd">        it may be called twice if no precaution is taken to avoid it (a</span>
<span class="sd">        `__np_init_done__` instance attribute is set once init is done the</span>
<span class="sd">        first time).</span>

<span class="sd">        Ex::</span>

<span class="sd">            class Smooth(NipypeProcess):</span>
<span class="sd">                _nipype_class_type = spm.Smooth</span>
<span class="sd">                _nipype_trait_mapping = {</span>
<span class="sd">                    &#39;smoothed_files&#39;: &#39;smoothed_files&#39;,</span>
<span class="sd">                    &#39;_spm_script_file&#39;: &#39;spm_script_file&#39;}</span>

<span class="sd">            smooth = Smooth()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nipype_instance: nipype interface (mandatory, except from internals)</span>
<span class="sd">            the nipype interface we want to wrap in capsul.</span>
<span class="sd">        use_temp_output_dir: bool or None</span>
<span class="sd">            use a temp working directory during processing</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        _nipype_interface : Interface</span>
<span class="sd">            private attribute to store the nipye interface</span>
<span class="sd">        _nipype_module : str</span>
<span class="sd">            private attribute to store the nipye module name</span>
<span class="sd">        _nipype_class : str</span>
<span class="sd">            private attribute to store the nipye class name</span>
<span class="sd">        _nipype_interface_name : str</span>
<span class="sd">            private attribute to store the nipye interface name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;__NipypeProcess_np_init_done__&#39;</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__NipypeProcess_np_init_done__</span><span class="p">:</span>
            <span class="c1"># may be called twice, from within __new__ or from python internals</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__NipypeProcess_np_init_done__</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1">#super(NipypeProcess, self).__init__(*args, **kwargs)</span>

        <span class="c1"># Set some class attributes that characterize the nipype interface</span>
        <span class="k">if</span> <span class="n">nipype_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># probably called from a specialized subclass</span>
            <span class="n">np_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_nipype_class_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np_class</span><span class="p">:</span>
                <span class="n">nipype_instance</span> <span class="o">=</span> <span class="n">np_class</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s1">&#39;NipypeProcess.__init__ must either be called with a &#39;</span>
                    <span class="s1">&#39;nipype interface instance as 1st argument, or from a &#39;</span>
                    <span class="s1">&#39;specialized subclass providing the _nipype_class_type &#39;</span>
                    <span class="s1">&#39;class attribute&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span> <span class="o">=</span> <span class="n">nipype_instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_module</span> <span class="o">=</span> <span class="n">nipype_instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_class</span> <span class="o">=</span> <span class="n">nipype_instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">msplit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_module</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface_name</span> <span class="o">=</span> <span class="n">msplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface_name</span> <span class="o">=</span> <span class="s1">&#39;custom&#39;</span>

        <span class="c1"># Inheritance: activate input files copy for spm interfaces.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface_name</span> <span class="o">==</span> <span class="s2">&quot;spm&quot;</span><span class="p">:</span>
            <span class="c1"># Copy only &#39;copyfile&#39; nipype traits</span>
            <span class="n">inputs_to_copy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">traits</span><span class="p">(</span>
                <span class="n">copyfile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">inputs_to_symlink</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">traits</span><span class="p">(</span>
                <span class="n">copyfile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">out_traits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">output_spec</span><span class="p">()</span><span class="o">.</span><span class="n">traits</span><span class="p">()</span>
            <span class="n">inputs_to_clean</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs_to_copy</span>
                               <span class="k">if</span> <span class="s1">&#39;modified_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out_traits</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">use_temp_output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">use_temp_output_dir</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">NipypeProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">activate_copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inputs_to_copy</span><span class="o">=</span><span class="n">inputs_to_copy</span><span class="p">,</span>
                <span class="n">inputs_to_symlink</span><span class="o">=</span><span class="n">inputs_to_symlink</span><span class="p">,</span>
                <span class="n">inputs_to_clean</span><span class="o">=</span><span class="n">inputs_to_clean</span><span class="p">,</span>
                <span class="n">use_temp_output_dir</span><span class="o">=</span><span class="n">use_temp_output_dir</span><span class="p">,</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_temp_output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">use_temp_output_dir</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">NipypeProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                  <span class="n">activate_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_temp_output_dir</span><span class="o">=</span><span class="n">use_temp_output_dir</span><span class="p">,</span>
                  <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Replace the process name and identification attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_nipype_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_class</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># Add a new trait to store the processing output directory</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;output_directory&quot;</span><span class="p">,</span> <span class="n">Directory</span><span class="p">(</span><span class="n">Undefined</span><span class="p">,</span> <span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># Add a &#39;synchronize&#39; nipype input trait that will be used to trigger</span>
        <span class="c1"># manually the output nipype/capsul traits sync.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;synchronize&quot;</span><span class="p">,</span> <span class="n">Int</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># use the nipype doc for help</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nipype_instance</span><span class="p">,</span> <span class="s1">&#39;__doc__&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__postinit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        `__postinit__` allows to customize subclasses. the base `NipypeProcess`</span>
<span class="sd">        implementation does nothing, it is empty.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span>


<div class="viewcode-block" id="NipypeProcess.requirements">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.NipypeProcess.requirements">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nipype&#39;</span><span class="p">:</span> <span class="s1">&#39;any&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface_name</span> <span class="o">==</span> <span class="s2">&quot;spm&quot;</span><span class="p">:</span>
            <span class="n">req</span><span class="p">[</span><span class="s1">&#39;spm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface_name</span> <span class="o">==</span> <span class="s2">&quot;fsl&quot;</span><span class="p">:</span>
            <span class="n">req</span><span class="p">[</span><span class="s1">&#39;fsl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface_name</span> <span class="o">==</span> <span class="s2">&quot;freesurfer&quot;</span><span class="p">:</span>
            <span class="n">req</span><span class="p">[</span><span class="s1">&#39;freesurfer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span>
        <span class="k">return</span> <span class="n">req</span></div>



<div class="viewcode-block" id="NipypeProcess.set_output_directory">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.NipypeProcess.set_output_directory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_output_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set the process output directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        out_dir: str (mandatory)</span>
<span class="sd">            the output directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">out_dir</span></div>


<div class="viewcode-block" id="NipypeProcess.set_usedefault">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.NipypeProcess.set_usedefault">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_usedefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set the value of the usedefault attribute on a given parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter: str (mandatory)</span>
<span class="sd">            name of the parameter to modify.</span>
<span class="sd">        value: bool (mandatory)</span>
<span class="sd">            value set to the usedefault attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_before_run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface_name</span> <span class="o">==</span> <span class="s2">&quot;spm&quot;</span><span class="p">:</span>
            <span class="c1"># Set the spm working</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NipypeProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_before_run_process</span><span class="p">()</span>
        <span class="c1"># configure nipype from config env variables (which should have been set</span>
        <span class="c1"># before now)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">capsul.in_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">nipype</span> <span class="k">as</span> <span class="n">inp_npp</span>
        <span class="n">inp_npp</span><span class="o">.</span><span class="n">configure_all</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method that do the processing when the instance is called.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        runtime: InterfaceResult</span>
<span class="sd">            object containing the running results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;output_directory is not set but is mandatory &#39;</span>
                             <span class="s1">&#39;to run a NipypeProcess&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synchronize</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">trait_map</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_nipype_trait_mapping&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># Force nipype update</span>
        <span class="k">for</span> <span class="n">trait_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">traits</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">capsul_name</span> <span class="o">=</span> <span class="n">trait_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trait_name</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">capsul_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
                <span class="n">old</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">)</span>
                <span class="n">new</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capsul_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="n">Undefined</span> <span class="ow">and</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synchronize</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># update outputs from nipype</span>
        <span class="k">for</span> <span class="n">trait_name</span> \
                <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">output_spec</span><span class="p">()</span><span class="o">.</span><span class="n">traits</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">capsul_name</span> <span class="o">=</span> <span class="n">trait_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trait_name</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">capsul_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_traits</span><span class="p">():</span>
                <span class="n">old</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capsul_name</span><span class="p">)</span>
                <span class="n">new</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">output_spec</span><span class="p">(),</span>
                              <span class="n">trait_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capsul_name</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

        <span class="c1"># For spm, need to move the batch</span>
        <span class="c1"># (create in cwd: cf nipype.interfaces.matlab.matlab l.181)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface_name</span> <span class="o">==</span> <span class="s2">&quot;spm&quot;</span><span class="p">:</span>
            <span class="n">mfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">mlab</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">script_file</span><span class="p">)</span>
            <span class="n">destmfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">mlab</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">script_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">mfile</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">mfile</span><span class="p">,</span> <span class="n">destmfile</span><span class="p">)</span>

        <span class="c1"># Restore cwd</span>
        <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1">#return results.__dict__</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_after_run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_process_result</span><span class="p">):</span>
        <span class="n">trait_map</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_nipype_trait_mapping&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">script_tname</span> <span class="o">=</span> <span class="n">trait_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_spm_script_file&#39;</span><span class="p">,</span> <span class="s1">&#39;_spm_script_file&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_tname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">script_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nipype_interface</span><span class="o">.</span><span class="n">mlab</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">script_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">script_file</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">script_file</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_tname</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">NipypeProcess</span><span class="p">,</span>
                     <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_after_run_process</span><span class="p">(</span><span class="n">run_process_result</span><span class="p">)</span>

<div class="viewcode-block" id="NipypeProcess.help">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.NipypeProcess.help">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">help</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nipype_interface</span><span class="p">,</span> <span class="n">returnhelp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to print the full wrapped nipype interface help.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cls: process class (mandatory)</span>
<span class="sd">            a nipype process class</span>
<span class="sd">        nipype_instance: nipype interface (mandatory)</span>
<span class="sd">            a nipype interface object that will be documented.</span>
<span class="sd">        returnhelp: bool (optional, default False)</span>
<span class="sd">            if True return the help string message,</span>
<span class="sd">            otherwise display it on the console.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.nipype_process</span><span class="w"> </span><span class="kn">import</span> <span class="n">nipype_factory</span>
        <span class="n">cls_instance</span> <span class="o">=</span> <span class="n">nipype_factory</span><span class="p">(</span><span class="n">nipype_interface</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls_instance</span><span class="o">.</span><span class="n">get_help</span><span class="p">(</span><span class="n">returnhelp</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="InteractiveProcess">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.InteractiveProcess">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">InteractiveProcess</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Base class for interactive processes. The value of the is_interactive </span>
<span class="sd">    parameter determine if either the process can be run in background</span>
<span class="sd">    (eventually remotely) as a standard process (is_interactive = False)</span>
<span class="sd">    or if the process must be executed interactively in the user environment</span>
<span class="sd">    (is_interactive = False).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">is_interactive</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProcessResult">
<a class="viewcode-back" href="../../../api/process.html#capsul.process.process.ProcessResult">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ProcessResult</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Object that contains running information a particular Process.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    process : Process class (mandatory)</span>
<span class="sd">        A copy of the `Process` class that was called.</span>
<span class="sd">    runtime : dict (mandatory)</span>
<span class="sd">        Execution attributes.</span>
<span class="sd">    returncode: dict (mandatory)</span>
<span class="sd">        Execution raw attributes</span>
<span class="sd">    inputs :  dict (optional)</span>
<span class="sd">        Representation of the process inputs.</span>
<span class="sd">    outputs : dict (optional)</span>
<span class="sd">        Representation of the process outputs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">runtime</span><span class="p">,</span> <span class="n">returncode</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize the ProcessResult class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">runtime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">returncode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">outputs</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CAPSUL</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CAPSUL</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, Populse team &lt;support@brainvisa.info&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>