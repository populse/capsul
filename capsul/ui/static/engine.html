<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Capsul dashboard</title>
  <script type="text/javascript" src="controller.js"></script>
  <link rel="stylesheet" href="controller.css">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="capsul.css">
</head>

<body>
  <h1>Engine <span id="engine_label"></span></h1>
  <table>
      <tbody  id="status_table">
      </tbody>
  </table>

  <h2>Executions</h2>
  <table>
      <thead>
        <th>Label</th>
        <th>Status</th>
        <th>Waiting</th>
        <th>Ready</th>
        <th>Ongoing</th>
        <th>Done</th>
        <th>Failed</th>
      </thead>
      <tbody id="executions_table">
      </tbody>
  </table>
  </body>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  var engine_label = urlParams.get("engine_label");
  document.getElementById("engine_label").textContent = engine_label;

  var web_backend = new WebBackend('http://localhost:8080/backend');

    function set_engine_status(engine_status) {
      let status_table = document.getElementById("status_table");
      for (let [name, value] of Object.entries(engine_status)) {
        let tr = document.createElement("tr");
        if (typeof value === 'object' && value !== null) {
          value = '<pre>' + JSON.stringify(value, undefined, 2) + '</pre>';
        }
        tr.innerHTML = '<tr><th>' + name + '</th><td>' + value + '</td></tr>'
        status_table.appendChild(tr);
      }
    }

    function set_executions_summary(executions_summary) {
      let status_table = document.getElementById("executions_table");
      for (const e of executions_summary) {
        let status_icon;
        if ( e['failed'] )
            status_icon = '‚ùå';
        else if ( e['ongoing'] )
            status_icon = 'üèÉ';
        else if ( e['waiting'] || e['ready'])
            status_icon = '‚è≥';
        else
            status_icon = '‚úÖ';
          let tr = document.createElement("tr");
        tr.innerHTML = '<tr><td><a href="execution.html?engine_label=' +
          e['engine_label'] + '&execution_id=' + e['execution_id'] + '">' + status_icon + ' ' + e['label'] +
          '</td><td>' + e['status'] + '</td><td>' + e['waiting'] + '</td><td>' +
          e['ready'] + '</td><td>' + e['ongoing'] + '</td><td>' + e['done'] +
          '</td><td>' + e['failed'] + '</td></tr>';
        status_table.appendChild(tr);
      }
    }

    window.addEventListener("backend_ready", async (event) => {
      const engine_status = await web_backend.call('engine_status', engine_label);
      set_engine_status(engine_status);
      const executions_summary = await web_backend.call('executions_summary', engine_label);
      set_executions_summary(executions_summary);
    });
  </script>
</html>
